---
title: "Shade tree influence on coffee disease"
author: "Mathis Gheno"
date: "2024-12-05"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup-options, include = F}
knitr::opts_chunk$set(warning = FALSE, message = FALSE)
```

# 1 Load Packages

```{r include=FALSE}
library(tidyverse)
library(readxl)
library(ggsci)
library(GGally)
library(ggsignif)

library(car)
library(glmmTMB)
library(effects)
library(emmeans)
library(ggeffects)
library(DHARMa)


library(sf)

main_theme = theme_minimal()+
  theme(line = element_blank(), 
        axis.line = element_line(colour = "black"),
        panel.border = element_blank(),
        axis.ticks =  element_line(colour = "black"),
        axis.text.x = element_text(colour = "black", size=18, face="italic", angle = 45, vjust = 1, hjust = 1),
        axis.text.y = element_text(colour = "black", size=18, face="italic"),
        legend.title = element_text(colour = "black", size=20,
                                    hjust =0.5),

        legend.text = element_text(colour = "black", size=18),
        axis.title= element_text(size=20),
        strip.text = element_text(colour = "black", size=15, face ="italic"))

```

# 2 Arrange data to long format

## 2.1 Compute incidence for each trees

```{r include=FALSE}
data <- read_xlsx("data/R_PhD_Data_corrected2.xlsx")
data %>% filter(is.na(Shade_tree_Canopy_Cover))
data %>%
  rename(sample_code = "Coffee_soil _sample_CODE") %>%
  mutate(sample_code = paste(sample_code,
                             str_extract(Section_of_Kaweri, "^[a-zA-Z]{4}"), sep = "_"),
         Shade_tree_soil_sample_CODE = paste(Shade_tree_soil_sample_CODE,
                             str_extract(Section_of_Kaweri, "^[a-zA-Z]{4}"), sep = "_")) -> data



covariate_data <- data %>%
  dplyr::select(Shade_tree_species, Section_of_Kaweri, sample_code, Coffee_Variety,
         Actual_distance_from_shade_tree_m, Shade_tree_soil_sample_CODE) %>% 
  mutate(Coffee_Variety = case_when(is.na(Coffee_Variety) ~"unknown_var",
                                    .default = Coffee_Variety))

 data %>% 
  dplyr::select(sample_code, starts_with("inc"), starts_with("Inc")) %>%
  pivot_longer(-sample_code, values_to = "value", names_to = "value_type") %>%
  mutate(
    # Extracting "disease" (e.g., "CWD", "CLR", "CRBD")
    disease = str_extract(value_type, "(?<=_)[A-Z]+"),
    
    # Extracting "portion"
    portion = str_extract(value_type, "(?<=_)lower|Top|middle"),
    
    # Extracting "branch" (e.g., "1st", "2nd", "3rd", "4th")
    branch = str_extract(value_type, "\\d+(st|nd|rd|th)"),
    
    # Extracting "value_type" (e.g., "incidence" or "Incidence")
    value_type = str_extract(value_type, "^[^_]+"),
    
    # change "Incidence"  to "incidence")
    value_type = str_replace_all(value_type, "Incidence", "incidence")
  ) %>%
  mutate(value = ifelse(value>=1,1,0 )) %>%
  left_join(covariate_data, by = "sample_code") %>%
  group_by(sample_code, disease) %>% # sample code are the ID to individual coffee tree
  summarise(true_incidence = ifelse(sum(value, na.rm = T)>=1,1,0), # 0 occurrence = 0 ; 1 to 12 occurrence = 1
            n =  n(),
            distance = unique(Actual_distance_from_shade_tree_m),
            Shade_tree_species = unique(Shade_tree_species),
            Shade_tree_soil_sample_CODE = unique(Shade_tree_soil_sample_CODE),
            Coffee_Variety = unique(Coffee_Variety)) %>%
   ungroup() %>%
   mutate(Section_of_kawerie = str_extract(sample_code,"(?<=_).+"),
          across(where(is.character), ~as.factor(.x)))-> data_incidence
```

## 2.2 Compute severity for each branchs

```{r include=FALSE}
### Isolate total cont of leaves or berries per branch
data %>%
  dplyr::select(sample_code, starts_with("No_berries"),  starts_with("No_leaves")) %>%
  pivot_longer(-sample_code, names_to = "sample_type", values_to = "total_count") %>%
  mutate(
    # Extracting "organ" ("berries" or "leaves")
    organ = str_extract(sample_type, "(?<=_)berries|leaves"),
    
    # Extracting "portion"
    portion = str_extract(sample_type, "(?<=_)lower|Top|middle"),
    
    # Extracting "branch" (e.g., "1st", "2nd", "3rd", "4th")
    branch = str_extract(sample_type, "\\d+(st|nd|rd|th)")
   ) %>%
  dplyr::select(-sample_type) -> total_number_of_leaves_or_berries

### Isolate total count of leaves or berries infected per branchs
data %>%
  dplyr::select(sample_code, starts_with("No"),  -starts_with("No_berries"),  -starts_with("No_leaves")) %>% # extract the total number of leaves/berries and the number of leaves/berries infected
  pivot_longer(-sample_code, names_to = "sample_type", values_to = "infected_count") %>%
  mutate(
     # Extracting "disease" (e.g., "CWD", "CLR", "CRBD")
    disease = str_extract(sample_type, "(?<=_)[A-Z]+"),
    
    # Extracting "organ" ("berries" or "leaves")
    organ = str_extract(sample_type, "(?<=_)berries|leaves"),
    
    # Extracting "portion"
    portion = str_extract(sample_type, "(?<=_)lower|Top|middle"),
    
    # Extracting "branch" (e.g., "1st", "2nd", "3rd", "4th")
    branch = str_extract(sample_type, "\\d+(st|nd|rd|th)")
   ) -> number_of_infected_leaves_or_berries

## Merge data and compute serverity per branchs
number_of_infected_leaves_or_berries %>%
  left_join(total_number_of_leaves_or_berries, by = join_by("sample_code" == "sample_code",
                                                            "branch" == "branch",
                                                            "portion" == "portion",
                                                            "organ" == "organ")) %>%
  mutate(severity = infected_count/total_count) %>%
  left_join(covariate_data, by = "sample_code") %>%
  mutate(Shade_tree_species = as.factor(Shade_tree_species)) %>%
  rename(distance = "Actual_distance_from_shade_tree_m") %>%
  mutate(distance_class = cut(
      distance,
      breaks = c(0, 8, 16, 24),  # Specify the breakpoints
      labels = c("[0-8]", "(8-16]", "(16-22]"),  # Labels for each range
      right = F), # Indicates whether intervals are right-closed
    total_count = case_when(total_count > 250 ~ round(total_count/10), # correct error (5 branch have more than 150 leaves -> error due to one digit added when tipping)
                            .default = total_count),
    log_total_count = log(total_count),
    across(where(is.character),~as.factor(.x))) -> data_severity
## Tree with no leaves (to remove)
data_severity%>%
  group_by(sample_code)%>%
  summarise(total_count = sum(total_count, na.rm = T)) %>%
  filter(total_count ==0) %>%
  pull(sample_code)-> no_leave_trees
```

## 2.3 Data cleaning
before removing tree with no leaves
```{r}
data_incidence %>%
  group_by(Shade_tree_species, disease) %>%
  mutate(n_tot = n(),
            infected_count = sum(true_incidence,na.rm  =T)) %>%
  ggplot()+
  facet_wrap(~disease) +
  geom_bar(aes(Shade_tree_species, fill = as.factor(true_incidence)), position = "fill") +
  geom_text(aes(x=Shade_tree_species, y=0.2,group = Shade_tree_species, label = infected_count), col = "white") +
  geom_text(aes(x=Shade_tree_species, y=1.04,group = Shade_tree_species, label = n_tot)) +
  scale_fill_startrek() +
  labs(x = " Shade tree", y = "Proportion", fill = "Incidence") +
  main_theme +
    theme(
        axis.text.x = element_text(colour = "black", size=14, face="italic", angle = 45, vjust = 1, hjust = 1))

data_incidence %>%
  group_by(Shade_tree_species, Coffee_Variety,disease) %>%
  mutate(n_tot = n(),
            infected_count = sum(true_incidence,na.rm  =T)) %>%
  ggplot()+
  facet_wrap(~Coffee_Variety*disease) +
  geom_bar(aes(Shade_tree_species, fill = as.factor(true_incidence)), position = "fill") +
  geom_text(aes(x=Shade_tree_species, y=0.2,group = Shade_tree_species, label = infected_count), col = "white") +
  geom_text(aes(x=Shade_tree_species, y=1.04,group = Shade_tree_species, label = n_tot)) +
  scale_fill_startrek() +
  labs(x = " Shade tree", y = "Proportion", fill = "Incidence") +
  main_theme
```

after removing tree with no leaves
```{r}
data_incidence %>%
  filter(!(sample_code %in% no_leave_trees)) -> data_incidence

data_incidence %>%
  group_by(Shade_tree_species, disease) %>%
  mutate(n_tot = n(),
            infected_count = sum(true_incidence,na.rm  =T)) %>%
  ggplot()+
  facet_wrap(~disease) +
  geom_bar(aes(Shade_tree_species, fill = as.factor(true_incidence)), position = "fill") +
  geom_text(aes(x=Shade_tree_species, y=0.2,group = Shade_tree_species, label = infected_count), col = "white") +
  geom_text(aes(x=Shade_tree_species, y=1.04,group = Shade_tree_species, label = n_tot)) +
  scale_fill_startrek() +
  labs(x = " Shade tree", y = "Proportion", fill = "Incidence") +
  main_theme +
    theme(
        axis.text.x = element_text(colour = "black", size=14, face="italic", angle = 45, vjust = 1, hjust = 1))
data_incidence %>%
  group_by(Shade_tree_species, Coffee_Variety,disease) %>%
  mutate(n_tot = n(),
            infected_count = sum(true_incidence,na.rm  =T)) %>%
  ggplot()+
  facet_wrap(~Coffee_Variety*disease) +
  geom_bar(aes(Shade_tree_species, fill = as.factor(true_incidence)), position = "fill") +
  geom_text(aes(x=Shade_tree_species, y=0.2,group = Shade_tree_species, label = infected_count), col = "white") +
  geom_text(aes(x=Shade_tree_species, y=1.04,group = Shade_tree_species, label = n_tot)) +
  scale_fill_startrek() +
  labs(x = " Shade tree", y = "Proportion", fill = "Incidence") +
  main_theme
```

before removing clone H and D

```{r}
data_incidence %>%
  filter( disease == "CWD") %>%
  group_by(Shade_tree_species, Coffee_Variety) %>%
  mutate(n_tot = n(),
            infected_count = sum(true_incidence,na.rm  =T)) %>%
  ggplot()+
  facet_wrap(~Coffee_Variety) +
  geom_bar(aes(Shade_tree_species, fill = as.factor(true_incidence)), position = "fill") +
  geom_text(aes(x=Shade_tree_species, y=0.2,group = Shade_tree_species, label = infected_count), col = "white") +
  geom_text(aes(x=Shade_tree_species, y=1.04,group = Shade_tree_species, label = n_tot)) +
  scale_fill_startrek() +
  labs(x = " Shade tree", y = "Proportion", fill = "Incidence") +
  main_theme
```

after removing clone H and D
```{r}
 data_incidence %>%
  # mutate(Coffee_Variety = case_when(Coffee_Variety == "Clone H" ~ "Clone H or D",
  #                                   Coffee_Variety == "Clone D" ~ "Clone H or D",
  #                  .default = Coffee_Variety)) 
  filter(!(Coffee_Variety %in% c("Clone H", "Clone D")))-> data_incidence
data_incidence %>%
  filter( disease == "CWD") %>%
  group_by(Shade_tree_species, Coffee_Variety) %>%
  mutate(n_tot = n(),
            infected_count = sum(true_incidence,na.rm  =T)) %>%
  ggplot()+
  facet_wrap(~Coffee_Variety) +
  geom_bar(aes(Shade_tree_species, fill = as.factor(true_incidence)), position = "fill") +
  geom_text(aes(x=Shade_tree_species, y=0.2,group = Shade_tree_species, label = infected_count), col = "white") +
  geom_text(aes(x=Shade_tree_species, y=1.04,group = Shade_tree_species, label = n_tot)) +
  scale_fill_startrek() +
  labs(x = " Shade tree", y = "Proportion", fill = "Incidence") +
  main_theme
```

```{r include=FALSE}
data_severity %>%
  filter(!(sample_code %in% no_leave_trees)) -> data_severity
```



# 3 Incidence model

## 3.1 CRBD incidence data

### Shade tree

```{r include=FALSE}
data_incidence %>%
  filter(disease == "CRBD") -> binary_data_CRBD

## Compute binomial glm  
mod_binary_incidence_CRBD <- glm(formula = true_incidence ~Shade_tree_species*(distance + Coffee_Variety),
                              family = binomial,
                              data = binary_data_CRBD)

```

```{r include=FALSE}
res_incidence_CRBD<- DHARMa::simulateResiduals(mod_binary_incidence_CRBD, plot = TRUE)
testDispersion(res_incidence_CRBD)
testZeroInflation(res_incidence_CRBD)
```

**The model:glm(formula = Incidence_CRBD \~ Shade_tree_species`*`distance + Coffee_Variety, family = binomial)**

```{r echo=FALSE}
## Anova of type 2 and 3 are more robust that basic anova 
anova(mod_binary_incidence_CRBD)
car::Anova(mod_binary_incidence_CRBD, 2) %>%
  round(2)

car::Anova(mod_binary_incidence_CRBD, 3)%>%
  round(2)
plot(allEffects(mod_binary_incidence_CRBD))
binary_data_CRBD$true_incidence

```

No effect (see anova type 2 and 3)
```{r}
library(jtools)
binary_data_CRBD$Coffee_Variety
summ(mod_binary_incidence_CRBD)
effect_plot(mod_binary_incidence_CRBD, pred = Shade_tree_species, interval = TRUE,x.label = "A",
            cat.interval.geom = c("linerange"),

            plot.points = TRUE, data = binary_data_CRBD, partial.residuals = T,
            int.type = "confidence",
            point.size = 1.5)

emmeans::emmeans(mod_binary_incidence_CRBD,
    ~Shade_tree_species,
    type = "response",
    adjust  = "sidak"
  ) %>% pairs

```

```{r echo=FALSE}

predict_response(mod_binary_incidence_CRBD, c("Coffee_Variety"), margin = "empirical") %>% #  margin = "marginalmeans" is to average over all shade tree, ortherwise prediction would be fixe for reference shade tree (albizia)
  as.data.frame %>%
  ggplot() +
  geom_pointrange(aes(x = x, y = predicted, ymin = conf.low, ymax = conf.high,), 
                  linetype =1, cex = 0.5, linewidth = 1, position = position_dodge(width = .2)) +

  scale_y_continuous(limits = c(0,1))+
  main_theme +
  labs(x= "Coffee Variety", y = "Incidence probability CRBD")

predict_response(mod_binary_incidence_CRBD, c("distance[all]"), margin = "empirical") %>%
  ggplot() +
  geom_line(aes(x, predicted), cex =2) +
  scale_y_continuous(limits = c(0,1))+
  main_theme +
  labs(x= "distance", y = "Incidence probability CRBD")

predict_response(mod_binary_incidence_CRBD, c("Shade_tree_species"), 
                 margin ="empirical") %>% #  margin = "marginalmeans" is to average over all shade tree, ortherwise prediction would be fixe for reference shade tree (albizia)
  as.data.frame %>%
  ggplot() +
  facet_wrap(~group)+
  geom_pointrange(aes(x = x, y = predicted, ymin = conf.low, ymax = conf.high,), 
                  linetype =1, cex = 0.5, linewidth = 1, position = position_dodge(width = .2)) +
  scale_y_continuous(limits = c(0,1))+
  main_theme +
  labs(x= "Shade tree", y = "Incidence probability CRBD")

predict_response(mod_binary_incidence_CRBD, c("distance [all]","Shade_tree_species"), type = "fixed", margin = "empirical") %>%
  as.data.frame %>%
  ggplot() +
  geom_ribbon(aes(x = x, y = predicted, ymin = conf.low, ymax = conf.high), alpha= 0.5 )+
  geom_line(aes(x = x, y = predicted))+
  facet_wrap(~group) +
  scale_y_continuous(limits = c(0,1))+
  main_theme +
  labs(x= "Distance", y = "Incidence probability CRBD") 
```

-   No differences of CRDB incidence detected between coffee variety.
-   Distance alone doesn't influence significantly CRDB incidence.
-   Shade trees species alone tree doesn't influence significantly CRDB incidence
-   Interaction between Shade trees and distance doesn't influence significantly CRDB incidence.

### 3.2 CWD incidence data

#### Shade tree

```{r}
table(binary_data_CWD$Shade_tree_soil_sample_CODE)
data_incidence %>%
  filter(disease == "CWD")%>%
  mutate(Coffee_Variety = as.factor(as.character(Coffee_Variety))) -> binary_data_CWD
 
glm(formula = true_incidence ~  Shade_tree_soil_sample_CODE ,
                              family = binomial,
                              data = binary_data_CWD) %>% residuals() %>%hist(breaks = 50)
binary_data_CWD$res_test = res_test
mod_binary_incidence_CWD <- glm(formula = res_test ~ Shade_tree_species * distance * Coffee_Variety,
                              family = gaussian(),
                              data = binary_data_CWD)
## Compute binomial glm  
mod_binary_incidence_CWD <- glm(formula = true_incidence ~ Shade_tree_species * (distance + Coffee_Variety) +
                                  distance:Coffee_Variety,
                              family = binomial,
                              data = binary_data_CWD)
summary(mod_binary_incidence_CWD)
```

```{r include=FALSE}
table(binary_data_CWD$Shade_tree_soil_sample_CODE)
res_incidence_CWD<- DHARMa::simulateResiduals(mod_binary_incidence_CWD, plot = TRUE)
testDispersion(res_incidence_CWD)
testZeroInflation(res_incidence_CWD)

```

**The model : glm(formula = Incidence_CWD \~ Shade_tree_species\*distance + Coffee_Variety, family = binomial )**

```{r}
## Anova 
car::Anova(mod_binary_incidence_CWD, 2) %>%
  round(2)
car::Anova(mod_binary_incidence_CWD, 3)

```

Tendency of Coffee variety on Incidence of CWD, I'm doing a postHoc pairwise comparison to see if there are some difference between varieties.

```{r}

### Pairwise  comparison
pwc_incidence_CWD <- emmeans(mod_binary_incidence_CWD, ~Coffee_Variety)
pairs(pwc_incidence_CWD)
pairs(pwc_incidence_CWD) %>% plot
multcomp::cld(pwc_incidence_CWD, Letter = "abcdefg") %>%
  as.data.frame() %>%
  dplyr::select(Coffee_Variety, .group) -> compl_letter 

### Variety
predict_response(mod_binary_incidence_CWD, c("Coffee_Variety"), margin = "empirical") %>% #  margin = "marginalmeans" is to average over all shade tree, ortherwise prediction would be fixe for reference shade tree (albizia)
  #plot(show_data =F, show_title = F) +
  as.data.frame() %>%
  ggplot(aes(x = x, y= predicted)) +
  geom_point()+
  geom_pointrange(aes(ymin = conf.low, ymax = conf.high,), 
                  linetype =1, cex = 0.5, linewidth = 1, position = position_dodge(width = .2)) +
  geom_signif(comparisons = list(c("Clone C", "Unidentified")),
              annotations = "p.val = 0.054") +
  scale_y_continuous(limits = c(0,1))+
  labs(x= "Coffee varieties", y = "Incidence probability CWD") +
  main_theme +
    theme(
        axis.text.x = element_text(colour = "black", size=14, face="italic", angle = 0, vjust = 0, hjust = 0.5))

predict_response(mod_binary_incidence_CWD, c("distance[all]"), margin = "empirical") %>%
  as.data.frame %>%
  ggplot() +
  geom_line(aes(x, predicted), cex =2) +
  scale_y_continuous(limits = c(0,1))+
  main_theme +
  labs(x= "distance", y = "Incidence probability CWD")

predict_response(mod_binary_incidence_CWD, c("distance[all]", "Coffee_Variety[Clone A, Clone B]", "Shade_tree_species")) %>%
  plot(show_data =T,show_ci=F, show_title = F) +
  facet_wrap(~facet)+
  labs(x= "Shade tree species", y = "Incidence probability CWD", col  = "Coffee varieties") +
  main_theme +
    theme(
        axis.text.x = element_text(colour = "black", size=14, face="italic", angle = 0, vjust = 0, hjust = 0.5))

library(interactions)
library(ggsci)
binary_data_CWD %>%
  column_to_rownames("sample_code")


# predict_response(mod_binary_incidence_CWD, c("distance", "Shade_tree_species", "Coffee_Variety"),
#                   margin = "mean_reference") %>%
#   plot(show_residuals =T,show_ci=F, show_title = F,
#        dot_size  = 3, 
#       line_size  = 1.5) +
#   facet_grid(cols = vars(facet), row = vars(group))

# Here I'm using "interactions" package instead of "ggeffect." When we predict the full model "ggeffect" don't separate partial residual depending on the 
# variety and the shade tree specie (see plot commented above to compare)
interactions::interact_plot(mod_binary_incidence_CWD, pred = distance, modx =Shade_tree_species ,
              mod2 =Coffee_Variety,
              colors = "Set1",
              interval = T, plot.points = T, data = binary_data_CWD, partial.residuals = F,
              point.size = 3, 
              line.thickness = 1.5,
              alpha=0.4,
              vary.lty = F) +
  facet_grid(cols = vars(Coffee_Variety), row = vars(Shade_tree_species))+
  scale_y_continuous(limits = c(0,1))+
  labs(x = "Distance from shade tree (m)") +
  theme_classic()+
  theme(aspect.ratio = 1,
        plot.margin = margin(0, 0, 0, 0),
        axis.title.y = element_blank(),
        axis.text.y = element_blank(),
        strip.text.x = element_blank(),
        strip.text.y = element_blank(),
        legend.position = "None",
        panel.border = element_rect(colour = "black", fill = NA, linewidth = 1),
        axis.title.x = element_text(colour = "black", size=14, face="italic")) -> p1

# Now I'm using "ggeffect" to average prediction across all factors (with margin = empirical, see package description for more details). "interactions" can only make prediction by fixing non used predictor to the fist level for factor variable
predict_response(mod_binary_incidence_CWD, c("distance[all]", "Shade_tree_species"), margin = "empirical") %>%
  plot(show_data =T,show_ci=T, show_title = F,
        dot_size  = 3, 
        dot_alpha = 0.4,
        line_size  = 1.5) +
  facet_grid(row = vars(group),switch="both") +
  scale_y_continuous(limits = c(0,1))+
  labs(x = "Distance from shade tree (m)", y = "CWD incidence probability") +
  theme_classic()+
  theme(aspect.ratio = 1,
        plot.margin = margin(0, 0, 0, 0),
        axis.title.x = element_blank(),
        legend.position = "None",
        panel.border = element_rect(colour = "black", fill = NA, linewidth = 1),
        axis.title.y = element_text(colour = "black", size=14, face="italic")) -> p2

# interactions::interact_plot(mod_binary_incidence_CWD, pred = distance, modx =Shade_tree_species ,
#               interval = F, plot.points = T, data = binary_data_CWD, partial.residuals = T,
#               point.size = 3, 
#               line.thickness = 1.5,
#               vary.lty = F) + 
#   facet_grid(row = vars(Shade_tree_species),switch="both")+
#   labs(y = "CWD incidence probability") +
#   theme_classic()+
#   theme(aspect.ratio = 1,
#         plot.margin = margin(0, 0, 0, 0),
#         axis.title.x = element_blank(),
#         legend.position = "None",
#         panel.border = element_rect(colour = "black", fill = NA, linewidth = 1),
#         axis.title.y = element_text(colour = "black", size=14, face="italic")) -> p2
predict_response(mod_binary_incidence_CWD, c("distance[all]", "Coffee_Variety"), margin = "empirical") %>%
  plot(show_data =T,show_ci=T, show_title = F,
        colors = rep("black", 6),
        dot_size  = 3, 
        dot_alpha = 0.4,
        line_size  = 1.5,
        grid = T) +
  scale_y_continuous(limits = c(0,1))+
  facet_grid(cols = vars(group)) +
  labs(y = "CWD incidence probability") +
  theme_classic()+
  theme(aspect.ratio = 1,
        plot.margin = margin(0, 0, 0, 0),
        legend.position = "None",
        axis.title = element_blank(),
        axis.text = element_blank(),
        panel.border = element_rect(colour = "black", fill = NA, linewidth = 1)) -> p3

# interactions::interact_plot(mod_binary_incidence_CWD, pred = distance, modx =Coffee_Variety ,
#               interval = F, plot.points = T, data = binary_data_CWD, partial.residuals = T,
#               colors = rep("black", 6),
#               point.size = 3,, 
#               line.thickness = 1.5,
#               vary.lty = F,
#               facet.modx = F) + 
#   facet_grid(cols = vars(Coffee_Variety))+
#   theme_classic()+
#   theme(aspect.ratio = 1,
#         plot.margin = margin(0, 0, 0, 0),
#         legend.position = "None",
#         axis.title = element_blank(),
#         axis.text = element_blank(),
#         panel.border = element_rect(colour = "black", fill = NA, linewidth = 1)) -> p3

predict_response(mod_binary_incidence_CWD, c("distance[all]"), margin = "empirical") %>%
  plot(show_data =T,show_ci=T, show_title = F,
        dot_size  = 3, 
        dot_alpha = 0.4,
        line_size  = 1.5) +
  scale_y_continuous(limits = c(0,1))+
  theme_classic()+
  theme(aspect.ratio = 1,
        plot.margin = margin(0, 0, 0, 0),
        legend.position = "None",
        axis.title = element_blank(),
        axis.text = element_blank(),
        panel.border = element_rect(colour = "black", fill = NA, linewidth = 1)) -> p4

# jtools::effect_plot(mod_binary_incidence_CWD, pred = distance,
#               interval = F, plot.points = T, data = binary_data_CWD, partial.residuals = T,
#               point.size = 3, 
#               line.thickness = 1.5) + 
#   theme_classic()+
#   theme(aspect.ratio = 1,
#         plot.margin = margin(0, 0, 0, 0),
#         legend.position = "None",
#         axis.title = element_blank(),
#         axis.text = element_blank(),
#         panel.border = element_rect(colour = "black", fill = NA, linewidth = 1)) -> p4

predict_response(mod_binary_incidence_CWD, c("Coffee_Variety"), margin = "empirical") %>%
  plot(show_residuals =T,show_ci=T, show_title = F,
        dot_size  = 1.5, 
        dot_alpha = 0.2,
        line_size  = 1) +
  geom_segment(aes(x =3, xend = 6, y = 1, yend =1), color = "black") +
  geom_text(aes(x = 4.5, y =0.99, label = "**"), vjust = 0)+
  scale_y_continuous(limits = c(0,1))+
  labs(x= "Coffee Varieties", y = "Incidence probability")+
  theme_classic()+
  theme(aspect.ratio = 1,
        axis.line = element_line(colour = "black"),
        panel.border = element_blank(),
        axis.ticks =  element_line(colour = "black"),
        axis.text.x = element_text(colour = "black", size=13, face="italic", angle = -10, vjust = 0, hjust =0.5),
        axis.text.y = element_text(colour = "black", size=12, face="italic"),
        legend.text = element_text(colour = "black", size=18),
        axis.title= element_text(size=16,face="bold"),
        strip.text = element_text(colour = "black", size=15, face ="italic")) -> p5
p5

layout <- c(
  area(t = 0, l = 0, b = 2, r = 3.5),
  area(t = 3, l = 2, b = 10, r = 10),
  area(t = 3, l = 0, b = 10, r = 3.5),
  area(t = 0, l = 2, b = 2, r = 10)
)
p4 + p1 + p2 + p3+
  plot_layout(design = layout)

plotResiduals(res_incidence_CWD, form = as.character(binary_data_CWD$Shade_tree_soil_sample_CODE),
              quantreg = FALSE)
#pairwise comparison coffee var
predict_response(mod_binary_incidence_CWD, c("Coffee_Variety"), margin = "empirical") %>%
  test_predictions(test = "contrast")

#Slope pairwise comparison shade tree
p2
test_predictions(mod_binary_incidence_CWD, c("distance", "Shade_tree_species"), margin = "empirical", test = "trend")


test(emtrends(mod_binary_incidence_CWD, ~ Shade_tree_species,
               var = "distance"))
pairs(emtrends(mod_binary_incidence_CWD, ~ Shade_tree_species,
               var = "distance"))
layout2 <- c(
  area(t = 0, l = 0, b =10, r = 3.5),
  area(t = 0, l = 2, b = 10, r = 10)
)
p2+theme(axis.title.x =  element_text(size=16,face="bold"),
         axis.title.y =  element_text(size=16,face="bold"))+
  p5+theme(axis.title.y = element_blank())+
  plot_layout(design = layout2) &
  theme(plot.tag.position  = c(0.25, 1),
        plot.tag = element_text(size=16,face="italic"))&
  plot_annotation(tag_levels = 'A')



data.frame(x= as.character(binary_data_CWD$Shade_tree_soil_sample_CODE),y=res_test) %>%
  ggplot(aes(x=x,y=y)) +
    geom_boxplot()+
    geom_jitter()
# No difference significantly different from 0
emmeans(mod_binary_incidence_CWD,  ~ Shade_tree_species*( Coffee_Variety)) %>%
  pairs(by  ="Shade_tree_species") %>% plot
  

contrast(EMM, interaction = c("pairwise", "consec")) 
predict_response(mod_binary_incidence_CWD, c("distance [all]", "Shade_tree_species"),
                 type = "fixed", margin = "empirical") %>%  
  plot(show_data =T) + 
  facet_wrap(~group) +
  labs(x= "Distance", y = "Incidence probability CWD") +
  main_theme
  
```

-   No differences of CWD incidence detected between coffee variety.
-   Distance alone doesn't influence significantly CWD incidence.
-   Shade trees species alone tree doesn't influence significantly CWD incidence
-   Interaction between Shade trees and distance doesn't influence significantly CWD incidence.

### 3.3 CLR incidence data

#### Shade tree

```{r}
data_incidence %>%
  filter(disease == "CLR", Coffee_Variety != "Clone D", Coffee_Variety != "Clone H") -> binary_data_CLR

## Compute binomial glm  
mod_binary_incidence_CLR <- glm(formula = true_incidence ~ Shade_tree_species*(distance + Coffee_Variety), 
                              family = binomial,
                              data = binary_data_CLR)
```

```{r include=FALSE}
res_incidence_CLR<- DHARMa::simulateResiduals(mod_binary_incidence_CLR, plot = TRUE)
testDispersion(res_incidence_CLR)
testZeroInflation(res_incidence_CLR)
```

\*\*The model : glm(formula = Incidence_CLR \~ Shade_tree_species\*distance + Coffee_Variety, family = binomial )\*\*

```{r}
## Anova of type 2 and 3 are more robust that basic anova 
car::Anova(mod_binary_incidence_CLR, 2) %>%
  round(2)
car::Anova(mod_binary_incidence_CLR, 3)
```

```{r}

predict_response(mod_binary_incidence_CLR, c("Coffee_Variety"), type = "fixed") %>%
  as.data.frame %>%
  ggplot() +
  geom_pointrange(aes(x = x, y = predicted, ymin = conf.low, ymax = conf.high,), 
                  linetype =1, cex = 0.5, linewidth = 1, position = position_dodge(width = .2)) +
  scale_y_continuous(limits = c(0,1.1))+
  main_theme +
  labs(x= "Coffee Variety", y = "Incidence probability CLR") 



pwc_ClR_incid <- emmeans(mod_binary_incidence_CLR, ~Shade_tree_species| distance, component = 'response')


pairs(pwc_ClR_incid)
multcomp::cld(pwc_ClR_incid, Letter = "abcdefg") %>%
  as.data.frame() %>%
  dplyr::dplyr::select(Shade_tree_species, .group) -> compl_letter 

predict_response(mod_binary_incidence_CLR, c("Shade_tree_species"), type = "fixed") %>%
  as.data.frame %>%
  left_join(compl_letter, by = join_by(x == Shade_tree_species)) %>%
  ggplot() +
  geom_text(aes(label = .group, x = x, y = 1.05), size = 5, vjust = 0) +
  geom_pointrange(aes(x = x, y = predicted, ymin = conf.low, ymax = conf.high,), 
                  linetype =1, cex = 0.5, linewidth = 1, position = position_dodge(width = .2)) +
  scale_y_continuous(limits = c(0,1.1))+
  main_theme +
  labs(x= "Shade tree", y = "Incidence probability CLR") 

predict_response(mod_binary_incidence_CLR, c("distance[all]"), margin = "marginalmeans") %>%
  as.data.frame %>%
  ggplot() +
  geom_line(aes(x, predicted), cex =2) +
  scale_y_continuous(limits = c(0,1))+
  main_theme +
  labs(x= "distance", y = "Incidence probability CLR")

predict_response(mod_binary_incidence_CLR, c("distance [all]","Shade_tree_species"), type = "fixed") %>%
  as.data.frame %>%
  ggplot() +
  geom_ribbon(aes(x = x, y = predicted, ymin = conf.low, ymax = conf.high), alpha= 0.5 )+
  geom_line(aes(x = x, y = predicted))+
  facet_wrap(~group) +
  scale_y_continuous(limits = c(0,1))+
  main_theme +
  labs(x= "Distance", y = "Incidence probability CLR") 
```

-   No differences of CLR incidence detected between coffee variety.
-   Distance alone doesn't influence significantly CLR incidence.
-   **Shade trees influence significantly CLR incidence, however there is no significant differences in pairwise comparison**
-   Interaction between Shade trees and distance doesn't influence significantly CLR incidence.

### 4.4 Recap incidence : graph

```{r}
data_incidence %>%
  filter( disease == "CRBD") %>%
  group_by(Shade_tree_species, Coffee_Variety) %>%
  mutate(n_tot = n(),
            infected_count = sum(true_incidence,na.rm  =T)) %>%
  ggplot()+
  facet_wrap(~Coffee_Variety) +
  geom_bar(aes(Shade_tree_species, fill = as.factor(true_incidence)), position = "fill") +
  geom_text(aes(x=Shade_tree_species, y=0.2,group = Shade_tree_species, label = infected_count), col = "white") +
  geom_text(aes(x=Shade_tree_species, y=1.04,group = Shade_tree_species, label = n_tot)) +
  scale_fill_startrek() +
  labs(x = " Shade tree", y = "Proportion", fill = "Incidence") +
  main_theme
data_incidence %>%
  filter( disease == "CWD") %>%
  group_by(Shade_tree_species, Coffee_Variety) %>%
  mutate(n_tot = n(),
            infected_count = sum(true_incidence,na.rm  =T)) %>%
  ggplot()+
  facet_wrap(~Coffee_Variety) +
  geom_bar(aes(Shade_tree_species, fill = as.factor(true_incidence)), position = "fill") +
  geom_text(aes(x=Shade_tree_species, y=0.2,group = Shade_tree_species, label = infected_count), col = "white") +
  geom_text(aes(x=Shade_tree_species, y=1.04,group = Shade_tree_species, label = n_tot)) +
  scale_fill_startrek() +
  labs(x = " Shade tree", y = "Proportion", fill = "Incidence") +
  main_theme

data_incidence %>%
  filter( disease == "CLR") %>%
  group_by(Shade_tree_species, Coffee_Variety) %>%
  mutate(n_tot = n(),
            infected_count = sum(true_incidence,na.rm  =T)) %>%
  ggplot()+
  facet_wrap(~Coffee_Variety) +
  geom_bar(aes(Shade_tree_species, fill = as.factor(true_incidence)), position = "fill") +
  geom_text(aes(x=Shade_tree_species, y=0.2,group = Shade_tree_species, label = infected_count), col = "white") +
  geom_text(aes(x=Shade_tree_species, y=1.04,group = Shade_tree_species, label = n_tot)) +
  scale_fill_startrek() +
  labs(x = " Shade tree", y = "Proportion", fill = "Incidence") +
  main_theme

data_incidence %>%
  filter()

data_incidence %>%
  group_by(Shade_tree_species, disease) %>%
  mutate(n_tot = n(),
            infected_count = sum(true_incidence,na.rm  =T)) %>%
  ggplot()+
  facet_wrap(~disease) +
  geom_bar(aes(Shade_tree_species, fill = as.factor(true_incidence)), position = "fill") +
  geom_text(aes(x=Shade_tree_species, y=0.2,group = Shade_tree_species, label = infected_count), col = "white") +
  geom_text(aes(x=Shade_tree_species, y=1.04,group = Shade_tree_species, label = n_tot)) +
  scale_fill_startrek() +
  labs(x = " Shade tree", y = "Proportion", fill = "Incidence") +
  main_theme +
    theme(
        axis.text.x = element_text(colour = "black", size=14, face="italic", angle = 45, vjust = 1, hjust = 1))

data_incidence %>%
  group_by(Coffee_Variety, disease) %>%
  mutate(n_tot = n(),
            infected_count = sum( true_incidence,na.rm  =T)) %>%
  ggplot()+
  facet_wrap(~disease) +
  geom_bar(aes(Coffee_Variety, fill = as.factor(true_incidence)), position = "fill") +
  geom_text(aes(x=Coffee_Variety, y=0.2,group = Coffee_Variety, label = infected_count), col = "white") +
  geom_text(aes(x=Coffee_Variety, y=1.04,group = Coffee_Variety, label = n_tot)) +
  scale_fill_startrek() +
  labs(x = " Coffee Variety", y = "Proportion", fill = "Incidence") +
  main_theme

```

# 4 Severity model

## Severity correlation between diseases

```{r echo=FALSE}
data_severity %>%
  filter(organ != "berries",
         (portion == "Top" & disease %in% c("CRBD", "CWD")) |  portion == "lower" & disease == "CLR") %>%
  dplyr::dplyr::select(severity, sample_code, disease,branch) -> disease_corr_df

disease_corr_df %>%
  pivot_wider(names_from = disease, values_from = severity) %>% 
  dplyr::dplyr::select(CWD, CLR, CRBD) %>%
  rename(CWD_top = "CWD", CLR_low = "CLR", CRBD_top = "CRBD")%>%
  ggpairs() +
  theme_bw()+
  theme(line = element_blank(), 
        axis.line = element_line(colour = "black"),
        axis.ticks =  element_line(colour = "black"),
        axis.text.x = element_text(colour = "black", size=22, face="italic", angle = 45, vjust = 1, hjust = 1),
        axis.text.y = element_text(colour = "black", size=22, face="italic"),
        axis.title= element_text(size=20),
        strip.text = element_text(colour = "black", size=10, face ="italic"))

disease_corr_df %>%
  filter(severity != 0) %>%
  pivot_wider(names_from = disease, values_from = severity) %>%
  dplyr::dplyr::select(CWD, CLR, CRBD) %>%
  rename(CWD_top = "CWD", CLR_low = "CLR", CRBD_top = "CRBD")%>%
  ggpairs() +
  theme_bw()+
  theme(line = element_blank(), 
        axis.line = element_line(colour = "black"),
        axis.ticks =  element_line(colour = "black"),
        axis.text.x = element_text(colour = "black", size=22, face="italic", angle = 45, vjust = 1, hjust = 1),
        axis.text.y = element_text(colour = "black", size=22, face="italic"),
        axis.title= element_text(size=20),
        strip.text = element_text(colour = "black", size=10, face ="italic"))
```

```{r include=FALSE}

severity.mod.func <- function(data, 
                              frml,
                              zifrml,
                              disprml = formula("~1")){
 
  mod_severity <-  glmmTMB(formula = frml,
                              ziformula = zifrml,
                              dispformula = disprml,
                              family = beta_family(),
                              #weights = total_count ,
                              data = data)

  res_severity <- DHARMa::simulateResiduals(mod_severity, plot = TRUE)


  par(mfrow = c(2, 3))
  testDispersion(res_severity)
  testZeroInflation(res_severity)
  plotResiduals(res_severity, form = data$distance )
  plotResiduals(res_severity, form = data$Shade_tree_species)
  plotResiduals(res_severity, form = data$log_total_count)
  plotResiduals(res_severity, form = data$Coffee_Variety)
  par(mfrow = c(1, 1))
  
  return(mod_severity)
}

```

## 4.2 CRBD LEAVES severity model

```{r include=FALSE}
data_severity %>%
  filter(disease == "CRBD", organ =="leaves") -> data_severity_CRBD_leaves
1*0.999
```

### Top portion

```{r include=FALSE}
# Models
data_severity_CRBD_leaves %>%
  filter(portion =="Top", !is.na(severity)) %>%
  mutate(severity = case_when(severity == 1 ~ severity*0.999,
                              .default = severity))-> CRBD_leaves_top

CRBD_leaves_top%>%
  severity.mod.func(frml = formula("severity ~ Shade_tree_species *distance   + (1|Section_of_Kaweri)"),
                    zifrml = formula("~1")) -> mod_severity_CRBD_leaves_top

CRBD_leaves_top%>%
  severity.mod.func(frml = formula("severity ~ Shade_tree_species*distance   + Coffee_Variety +
                                            (1|Section_of_Kaweri)"),
                    zifrml = formula("~1")) -> mod_severity_CRBD_leaves_top2
CRBD_leaves_top%>%
  severity.mod.func(frml = formula("severity ~ Shade_tree_species*distance   + Coffee_Variety +
                                            (1|Section_of_Kaweri)"),
                              zifrml = formula("~Coffee_Variety")) -> mod_severity_CRBD_leaves_top3
CRBD_leaves_top%>%
  severity.mod.func(frml = formula("severity ~ Shade_tree_species*distance   + 
                                            (1|Section_of_Kaweri)"),
                              zifrml = formula("~Coffee_Variety ")) -> mod_severity_CRBD_leaves_top4

CRBD_leaves_top%>%
  severity.mod.func(frml = formula("severity ~ Shade_tree_species*distance   +
                                            (1|Section_of_Kaweri)"),
                    zifrml = formula("~Coffee_Variety"),
                    disprml = formula("~Coffee_Variety")) -> mod_severity_CRBD_leaves_top5
CRBD_leaves_top%>%
  severity.mod.func(frml = formula("severity ~ Shade_tree_species*distance   +Coffee_Variety +
                                            (1|Section_of_Kaweri)"),
                    zifrml = formula("~Coffee_Variety"),
                    disprml = formula("~Coffee_Variety")) -> mod_severity_CRBD_leaves_top6
CRBD_leaves_top%>%
  severity.mod.func(frml = formula("severity ~ Shade_tree_species*distance   +Coffee_Variety +
                                            (1|Section_of_Kaweri)"),
                    zifrml = formula("~1"),
                    disprml = formula("~Coffee_Variety")) -> mod_severity_CRBD_leaves_top6

```

**the model :**

-   **Formula:severity_CRBD \~ Shade_tree_species \* distance + (1 \| Section_of_Kaweri)** -
-   **Zero inflation : \~Coffee_Variety**
-   **Dispersion : \~Coffee_Variety**
-   **family:beta_family()**

```{r}

# Anova
Anova(mod_severity_CRBD_leaves_top5) %>%
  round(2)
Anova(mod_severity_CRBD_leaves_top5, 3) %>%
  round(2)

Anova(mod_severity_CRBD_leaves_top5, component = "zi") 

Anova(mod_severity_CRBD_leaves_top5, component = "disp") 

### Pairwise comparison variety
pwc_CRBD <- emmeans(mod_severity_CRBD_leaves_top5, ~Coffee_Variety, component = 'zi')

pairs(pwc_CRBD)
multcomp::cld(pwc_CRBD, Letter = "abcdefg") %>%
  as.data.frame() %>%
  dplyr::dplyr::select(Coffee_Variety, .group) -> compl_letter 

### Variety
predict_response(mod_severity_CRBD_leaves_top5, c("Coffee_Variety"), type = "zi_prob") %>% 
  as.data.frame %>%
  left_join(compl_letter, by = join_by(x == Coffee_Variety)) %>%
  mutate(x = factor(x, level = compl_letter$Coffee_Variety)) %>%
  ggplot() +
  geom_pointrange(aes(x = x, y = predicted, ymin = conf.low, ymax = conf.high), 
                  linetype =1, cex = 0.5, linewidth = 1, position = position_dodge(width = .2)) +
  geom_text(aes(label = .group, x = x, y = 1), size = 5, vjust = 0) +
  scale_y_continuous(limits = c(0,1))+
  main_theme +
  labs(x= "Variety", y = "Probability of CRBD lesion absence") 

### Distance
predict_response(mod_severity_CRBD_leaves_top5, c("distance[all]"), type = "fixed", margin = "marginalmeans") %>%
  as.data.frame %>%
  ggplot() +
  geom_ribbon(aes(x = x, y = predicted, ymin = conf.low, ymax = conf.high), alpha= 0.5) +
  geom_line(aes(x = x, y = predicted)) +
  scale_y_continuous(limits = c(0,0.5)) +
  labs(x = "Distance", y= "CRBD severity") +
  main_theme

### Distance
predict_response(mod_severity_CRBD_leaves_top5, c("distance[all]", "Shade_tree_species"), type = "zero_inflated") %>%
  as.data.frame %>%
  ggplot() +
  facet_wrap(~group)+
  geom_ribbon(aes(x = x, y = predicted, ymin = conf.low, ymax = conf.high), alpha= 0.5) +
  geom_line(aes(x = x, y = predicted)) +
  scale_y_continuous(limits = c(0,0.3)) +
  labs(x = "Distance", y= "CRBD severity") +
  main_theme
```

-   **Coffee variety influence probability of CRBD lesion absence at the branch level**
-   Distance alone doesn't influence significantly CRBD severity.
-   Shade trees doesn't influence significantly CRBD severity.
-   Interaction between Shade trees and distance doesn't influence significantly CRBD severity.

## 4.3 CWD severity model

```{r include=FALSE}
data_severity %>%
  filter(disease == "CWD") -> data_severity_CWD
```

### Top

```{r include=FALSE}
# Models

data_severity_CWD %>%
  filter(portion =="Top", !is.na(severity)) %>%
  mutate(severity = case_when(severity == 1 ~ severity*0.999,
                              .default = severity))-> CWD_top

CWD_top%>%
  severity.mod.func(frml = formula("severity ~ Shade_tree_species*distance + 
                                            (1|Section_of_Kaweri)"),
                    zifrml =  formula("~1")) -> mod_severity_CWD_top

CWD_top%>%
  severity.mod.func(frml = formula("severity ~ Shade_tree_species*distance   + Coffee_Variety + 
                                            (1|Section_of_Kaweri)"),
                     zifrml =  formula("~1")) -> mod_severity_CWD_top2
CWD_top%>%
  severity.mod.func(frml = formula("severity ~ Shade_tree_species*distance   + Coffee_Variety + 
                                            (1|Section_of_Kaweri)"),
                              zifrml = formula("~Coffee_Variety")) -> mod_severity_CWD_top3

CWD_top%>%
  severity.mod.func(frml = formula("severity ~ Shade_tree_species*distance  + 
                                            (1|Section_of_Kaweri)"),
                              zifrml = formula("~Coffee_Variety")) -> mod_severity_CWD_top4
CWD_top%>%
  severity.mod.func(frml = formula("severity ~ Shade_tree_species*distance  + 
                                            (1|Section_of_Kaweri)"),
                              zifrml = formula("~Shade_tree_species")) -> mod_severity_CWD_top5

```

-   **Model1:**
    -   **Formula: severity_CWD \~ Shade_tree_species \* distance + (1 \| Section_of_Kaweri)**
    -   **Zero inflation: \~1**
    -   **family = beta_family()**
-   **Model4:**
    -   **Formula: severity_CWD \~ Shade_tree_species \* distance + (1 \| Section_of_Kaweri)**
    -   **Zero inflation: \~Coffee_Variety**
    -   **family = beta_family()**
-   **Model5:**
    -   **Formula: severity_CWD \~ Shade_tree_species \* distance + (1 \| Section_of_Kaweri)**
    -   **Zero inflation: \~Shade_tree_species**
    -   **family = beta_family()**

```{r}
# dplyr::select model
AIC(mod_severity_CWD_top, mod_severity_CWD_top3, mod_severity_CWD_top4,mod_severity_CWD_top5) %>%
  round(1) 

# Anova Model 1
Anova(mod_severity_CWD_top) %>%
  round(2)
Anova(mod_severity_CWD_top,component = "zi") %>%
  round(2)
Anova(mod_severity_CWD_top, "III")%>%
  round(2)

# Anova Model 4
Anova(mod_severity_CWD_top4) %>%
  round(2)
Anova(mod_severity_CWD_top4,component = "zi") %>%
  round(2)
Anova(mod_severity_CWD_top4, "III") %>%
  round(2)

# Anova Model 5
Anova(mod_severity_CWD_top5) %>%
  round(2)
Anova(mod_severity_CWD_top5,component = "zi") %>%
  round(2)
Anova(mod_severity_CWD_top5, "III") %>%
  round(2)


### Pairwise comparison variety
pwc_CWD <- emmeans(mod_severity_CWD_top4, ~Coffee_Variety, component = 'zi')

pairs(pwc_CWD)
multcomp::cld(pwc_CWD, Letter = "abcdefg") %>%
  as.data.frame() %>%
  dplyr::dplyr::select(Coffee_Variety, .group) -> compl_letter 

### Variety
predict_response(mod_severity_CWD_top4, c("Coffee_Variety"), type = "zi_prob") %>% 
  as.data.frame %>%
  left_join(compl_letter, by = join_by(x == Coffee_Variety)) %>%
  mutate(x = factor(x, level = compl_letter$Coffee_Variety)) %>%
  ggplot() +
  geom_pointrange(aes(x = x, y = predicted, ymin = conf.low, ymax = conf.high), 
                  linetype =1, cex = 0.5, linewidth = 1, position = position_dodge(width = .2)) +
  geom_text(aes(label = .group, x = x, y = 1), size = 5, vjust = 0) +
  scale_y_continuous(limits = c(0,1))+
  main_theme +
  labs(x= "Variety", y = "Probability of CWD lesion absence") 

# Distance
predict_response(mod_severity_CWD_top4, c("distance[all]"), type = "fixed", margin = "marginalmeans") %>%
  as.data.frame %>%
  ggplot() +
  geom_ribbon(aes(x = x, y = predicted, ymin = conf.low, ymax = conf.high), alpha= 0.5) +
  geom_line(aes(x = x, y = predicted)) +
  scale_y_continuous(limits = c(0,0.5)) +
  labs(x = "Distance", y= "CWD severity") +
  main_theme

### Distance
predict_response(mod_severity_CWD_top4, c("distance[all]", "Shade_tree_species"), type = "zero_inflated") %>%
  as.data.frame %>%
  ggplot() +
  facet_wrap(~group)+
  geom_ribbon(aes(x = x, y = predicted, ymin = conf.low, ymax = conf.high), alpha= 0.5) +
  geom_line(aes(x = x, y = predicted)) +
  scale_y_continuous(limits = c(0,0.3)) +
  labs(x = "Distance", y= "CWD severity") +
  main_theme
```

AIC of model 1 4 and 5 aren't different enough to conclude which model is the more parsimonious (delta\<2)

-   **On the model 4 tendency of Coffee variety CWD lesion absence, but pairwise comparison show no effect**
-   Distance alone doesn't influence significantly CWD severity.
-   Shade trees doesn't influence significantly CWD severity.
-   Interaction between Shade trees and distance doesn't influence significantly CWD severity.

## 5.5 CLR severity model

```{r include=FALSE}
data_severity %>%
  filter(disease == "CLR") -> data_severity_CLR
```

### Low

```{r include=FALSE}
# Models
data_severity_CLR %>%
  filter(portion == "lower", !is.na(severity)) %>%
  mutate(severity = case_when(severity == 1 ~ severity*0.999,
                              .default = severity)) -> CLR_low

CLR_low %>%
 severity.mod.func(frml = formula("severity ~ Shade_tree_species*distance + 
                                            (1|Section_of_Kaweri)"),
                   zifrml =  formula("~1")) -> mod_severity_CLR_low
CLR_low %>%
 severity.mod.func(frml = formula("severity ~ Shade_tree_species*distance   + Coffee_Variety + 
                                            (1|Section_of_Kaweri)"),
                   zifrml = formula("~1")) -> mod_severity_CLR_low2
CLR_low %>%
 severity.mod.func(frml = formula("severity ~ Shade_tree_species*distance    + Coffee_Variety+
                                            (1|Section_of_Kaweri)"),
                   zifrml = formula("~Coffee_Variety")) -> mod_severity_CLR_low3
CLR_low %>%
 severity.mod.func(frml = formula("severity ~ Shade_tree_species*distance    + 
                                            (1|Section_of_Kaweri)"),
                   zifrml = formula("~Coffee_Variety")) -> mod_severity_CLR_low4

CLR_low%>%
  severity.mod.func(frml = formula("severity ~ Shade_tree_species*distance  + 
                                            (1|Section_of_Kaweri)"),
                    zifrml = formula("~Shade_tree_species")) -> mod_severity_CLR_low5
CLR_low%>%
  severity.mod.func(frml = formula("severity ~ Shade_tree_species*distance  + Coffee_Variety+
                                            (1|Section_of_Kaweri)"),
                    zifrml = formula("~Shade_tree_species")) -> mod_severity_CLR_low6

CLR_low %>%
 severity.mod.func(frml = formula("severity ~ Shade_tree_species*distance    + Coffee_Variety +
                                            (1|Section_of_Kaweri)"),
                    zifrml = formula("~Coffee_Variety"),
                    disprml =formula("~Coffee_Variety") ) -> mod_severity_CLR_low7
CLR_low %>%
 severity.mod.func(frml = formula("severity ~ Shade_tree_species*distance     +
                                            (1|Section_of_Kaweri)"),
                    zifrml = formula("~1"),
                    disprml =formula("~Coffee_Variety") ) -> mod_severity_CLR_low8

CLR_low %>%
 severity.mod.func(frml = formula("severity ~ Shade_tree_species*distance    +Coffee_Variety*distance+
                                            (1|Section_of_Kaweri)"),
                    zifrml = formula("~Coffee_Variety"),
                    disprml =formula("~log_total_count") ) -> mod_severity_CLR_low9
CLR_low %>%
 severity.mod.func(frml = formula("severity ~ Shade_tree_species*distance    +Coffee_Variety*distance+
                                            (1|Section_of_Kaweri)"),
                    zifrml = formula("~Coffee_Variety"),
                    disprml =formula("~log_total_count + Coffee_Variety") ) -> mod_severity_CLR_low10
CLR_low %>%
 severity.mod.func(frml = formula("severity ~ Shade_tree_species*distance    + Coffee_Variety*distance+ 
                                            (1|Section_of_Kaweri)"),
                    zifrml = formula("~Coffee_Variety*distance"),
                    disprml =formula("~Coffee_Variety*distance") ) -> mod_severity_CLR_low11


```

-   **Model:**
    -   **Formula:severity_CLR \~ Shade_tree_species \* distance + Coffee_Variety \* distance + (1 \| Section_of_Kaweri)**
    -   **Zero inflation:\~Coffee_Variety**
    -   **Dispersion:\~log_total_count + Coffee_Variety**
    -   **family:beta_family()**

**Using "log_total_count+ Coffee_Variety" in dispersion :**

-   For total number of leaves : it may influence severity variance the folowing way :
    -   *tot_leaves = 100 infected_leave=50 : severity= 50% -\> if you add 1 infected leave : severity = 51%*
    -   *tot_leaves = 10 infected_leave=5 : severity= 50% -\> if you add 1 infected leave : severity = 60%*

There is probably more variance of severity with a low number of leaves. For the 2 other disease (CRBD and CWD) beta_family distribution was able to tackle this variance, but for CLR it is to much thus we need to correct this effect with a dispersion parameter of "log_total_count".

-   Some Coffee variety could have different disease tolerance type that are effective or not depending the individuals resulting in a higher variance of severity. Other variety for which all individuals are ether full tolerant or full sensible would have much less variance.

-   **"Coffee_Variety\*distance" is the only way to have correct residuals for CLR models :**

    -   Coffee variety could react differently if they are close or far from a shade tree

```{r}
# Anova
Anova(mod_severity_CLR_low10) %>%
  round(2) 
Anova(mod_severity_CLR_low10,3)
Anova(mod_severity_CLR_low10,component = "zi") %>%
  round(2) 
Anova(mod_severity_CLR_low10,component = "disp") %>%
  round(2) 
summary(mod_severity_CLR_low10)
## Zero inflation
### Pairwise comparison variety
pwc_CLR_zi <- emmeans(mod_severity_CLR_low10, ~Coffee_Variety, component = 'zi')
pairs(pwc_CLR_zi)
multcomp::cld(pwc_CLR_zi, Letter = "abcdefg") %>%
  as.data.frame() %>%
  dplyr::dplyr::select(Coffee_Variety, .group) -> compl_letter_zi 

### Variety
predict_response(mod_severity_CLR_low10, c("Coffee_Variety"), type = "zi_prob") %>%
  as.data.frame %>%
  left_join(compl_letter_zi, by = join_by(x == Coffee_Variety)) %>%
  mutate(x = factor(x, level = compl_letter_zi$Coffee_Variety)) %>%
  ggplot() +
  geom_pointrange(aes(x = x, y = predicted, ymin = conf.low, ymax = conf.high,), 
                  linetype =1, cex = 0.5, linewidth = 1, position = position_dodge(width = .2)) +
  geom_text(aes(label = .group, x = x, y = 0.5), size = 5, vjust = 0) +
  scale_y_continuous(limits = c(0,0.5))+
  main_theme +
  labs(x= "Variety", y = "Probability of CLR lesion absence") 

## Response
pwc_CLR <- emmeans(mod_severity_CLR_low10, ~Coffee_Variety|distance, component = 'response')
pairs(pwc_CLR)
multcomp::cld(pwc_CLR, Letter = "abcdefg") %>%
  as.data.frame() %>%
  dplyr::dplyr::select(Coffee_Variety, .group) -> compl_letter 

### Variety
predict_response(mod_severity_CLR_low10, c("Coffee_Variety"), type = "zero_inflated") %>%
  as.data.frame %>%
  left_join(compl_letter, by = join_by(x == Coffee_Variety)) %>%
  mutate(x = factor(x, level = compl_letter$Coffee_Variety)) %>%
  ggplot() +
  geom_pointrange(aes(x = x, y = predicted, ymin = conf.low, ymax = conf.high,), 
                  linetype =1, cex = 0.5, linewidth = 1, position = position_dodge(width = .2)) +
  geom_text(aes(label = .group, x = x, y = 0.5), size = 5, vjust = 0) +
  scale_y_continuous(limits = c(0,0.5))+
  main_theme +
  labs(x= "Variety", y = "Severity CLR") 

### Distance
predict_response(mod_severity_CLR_low10, c("distance[all]"),  type = "fixed", margin = "marginalmeans") %>%
  as.data.frame %>%
  ggplot() +
 
  geom_ribbon(aes(x = x, y = predicted, ymin = conf.low, ymax = conf.high), alpha= 0.5) +

  geom_line(aes(x = x, y = predicted)) +
  scale_y_continuous(limits = c(0,0.4)) +
  labs(x = "Distance", y= "CLR severity") +
  main_theme

### variety interaction distance (partial effect of distance and Coffee_Variety)

#Slope pairwise comparison
pairs(emtrends(mod_severity_CLR_low10, pairwise ~ Coffee_Variety, var = "distance"))
#emmip(mod_severity_CLR_low10, Coffee_Variety ~ distance, cov.reduce = range)

predict_response(mod_severity_CLR_low10, c("distance [all]", "Coffee_Variety"), type = "fixed") %>%
  as.data.frame %>%
  ggplot() +
    facet_wrap(~group)+
  geom_ribbon(aes(x = x, y = predicted, ymin = conf.low, ymax = conf.high), alpha= 0.5) +

  geom_line(aes(x = x, y = predicted)) +
  scale_y_continuous(limits = c(0,0.6)) +
  labs(x = "Distance", y= "CLR severity") +
  main_theme



```

-   **Coffee variety:**
    -   **Has an effect on lesion absence**
    -   **Has an effect on severity intensity**
    -   **Has an effect on severity variance (some coffee variety have more severity variance than other)**
-   **Distance alone influence severity, however it has no more significant influence in type 3 anova.**
-   **Interaction between Distance and Coffee variety:**
    -   **Tendency, but pairwise comparison of slope between coffe variety show no difference**
-   Shade trees doesn't influence significantly CLR severity.
-   Interaction between Shade trees and distance doesn't influence significantly CLR severity.
