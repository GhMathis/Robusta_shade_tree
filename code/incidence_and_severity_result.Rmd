---
title: "Shade tree influence on coffee disease"
author: "Mathis Gheno"
date: "2024-12-05"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup-options, include = F}
knitr::opts_chunk$set(warning = FALSE, message = FALSE)
```

# 1 Load Packages

```{r include=FALSE}

library(performance)
library(modelbased)
library(tidyverse)
library(readxl)
library(ggsci)
library(GGally)
library(ggsignif)

library(patchwork)
library(car)
library(glmmTMB)
library(effects)
library(emmeans)
library(ggeffects)
library(DHARMa)
library(interactions)
library(ggsci)

library(sf)

main_theme = theme_minimal()+
  theme(line = element_blank(), 
        axis.line = element_line(colour = "black"),
        panel.border = element_blank(),
        axis.ticks =  element_line(colour = "black"),
        axis.text.x = element_text(colour = "black", size=18, face="italic", angle = 45, vjust = 1, hjust = 1),
        axis.text.y = element_text(colour = "black", size=18, face="italic"),
        legend.title = element_text(colour = "black", size=20,
                                    hjust =0.5),

        legend.text = element_text(colour = "black", size=18),
        axis.title= element_text(size=20),
        strip.text = element_text(colour = "black", size=15, face ="italic"))

```

# 2 Arrange data to long format

## 2.1 Compute incidence for each trees

```{r include=FALSE}
data <- read_xlsx("data/R_PhD_Data_corrected2.xlsx")
data %>% filter(is.na(Shade_tree_Canopy_Cover))
data %>%
  rename(sample_code = "Coffee_soil _sample_CODE") %>%
  # change sample names format
  mutate(sample_code = paste(sample_code,
                             str_extract(Section_of_Kaweri, "^[a-zA-Z]{4}"), sep = "_"),
         Shade_tree_soil_sample_CODE = paste(Shade_tree_soil_sample_CODE,
                             str_extract(Section_of_Kaweri, "^[a-zA-Z]{4}"), sep = "_")) %>% 
  mutate(Shade_tree_species = case_when(Shade_tree_species == "Ficus natalensis"~ "Fn",
                                        Shade_tree_species == "Albizia coriaria" ~ "Ac",
                                        Shade_tree_species == "Artocarpus heterophyllus" ~ "Ah",
                                        Shade_tree_species == "Persea americana" ~ "Pa"))-> data


# Isolate covariate from the main dataframe
covariate_data <- data %>%
  dplyr::select(Shade_tree_species, Section_of_Kaweri, sample_code, Coffee_Variety,
         Actual_distance_from_shade_tree_m, Shade_tree_soil_sample_CODE) %>% 
  mutate(Coffee_Variety = case_when(is.na(Coffee_Variety) ~"unknown_var",
                                    .default = Coffee_Variety))

 data %>% 
   # Select incidence columns 
  dplyr::select(sample_code, starts_with("inc"), starts_with("Inc")) %>%
  pivot_longer(-sample_code, values_to = "value", names_to = "value_type") %>%
  mutate(
    # Extracting "disease" (e.g., "CWD", "CLR", "CRBD")
    disease = str_extract(value_type, "(?<=_)[A-Z]+"),
    
    # Extracting "portion"
    portion = str_extract(value_type, "(?<=_)lower|Top|middle"),
    
    # Extracting "branch" (e.g., "1st", "2nd", "3rd", "4th")
    branch = str_extract(value_type, "\\d+(st|nd|rd|th)"),
    
    # Extracting "value_type" (e.g., "incidence" or "Incidence")
    value_type = str_extract(value_type, "^[^_]+"),
    
    # change "Incidence"  to "incidence")
    value_type = str_replace_all(value_type, "Incidence", "incidence")
  ) %>%
  # some value are above 1,  correct that:
  mutate(value = ifelse(value>=1,1,0 )) %>%
  left_join(covariate_data, by = "sample_code") %>%
  # sample code are the ID to individual coffee tree. I compute the incidence en the coffee shrub level and 
  # summarize the covariate at the same time
  group_by(sample_code, disease) %>% 
  summarise(true_incidence = ifelse(sum(value, na.rm = T)>=1,1,0), # 0 occurrence = 0 ; 1 to 12 occurrence = 1
            n =  n(),
            distance = unique(Actual_distance_from_shade_tree_m),
            Shade_tree_species = unique(Shade_tree_species),
            Shade_tree_soil_sample_CODE = unique(Shade_tree_soil_sample_CODE),
            Coffee_Variety = unique(Coffee_Variety)) %>%
   ungroup() %>%
   # exctract the section name and mutate character colum to factor
   mutate(Section_of_kawerie = str_extract(sample_code,"(?<=_).+"),
          across(where(is.character), ~as.factor(.x)))-> data_incidence
```

## 2.2 Compute severity for each branchs

```{r include=FALSE}
### Isolate total cont of leaves or berries per branch
data %>%
  dplyr::select(sample_code, starts_with("No_berries"),  starts_with("No_leaves")) %>%
  pivot_longer(-sample_code, names_to = "sample_type", values_to = "total_count") %>%
  mutate(
    # Extracting "organ" ("berries" or "leaves")
    organ = str_extract(sample_type, "(?<=_)berries|leaves"),
    
    # Extracting "portion"
    portion = str_extract(sample_type, "(?<=_)lower|Top|middle"),
    
    # Extracting "branch" (e.g., "1st", "2nd", "3rd", "4th")
    branch = str_extract(sample_type, "\\d+(st|nd|rd|th)")
   ) %>%
  dplyr::select(-sample_type) -> total_number_of_leaves_or_berries

### Isolate total count of leaves or berries infected per branchs
data %>%
  dplyr::select(sample_code, starts_with("No"),  -starts_with("No_berries"),  -starts_with("No_leaves")) %>% # extract the total number of leaves/berries and the number of leaves/berries infected
  pivot_longer(-sample_code, names_to = "sample_type", values_to = "infected_count") %>%
  mutate(
     # Extracting "disease" (e.g., "CWD", "CLR", "CRBD")
    disease = str_extract(sample_type, "(?<=_)[A-Z]+"),
    
    # Extracting "organ" ("berries" or "leaves")
    organ = str_extract(sample_type, "(?<=_)berries|leaves"),
    
    # Extracting "portion"
    portion = str_extract(sample_type, "(?<=_)lower|Top|middle"),
    
    # Extracting "branch" (e.g., "1st", "2nd", "3rd", "4th")
    branch = str_extract(sample_type, "\\d+(st|nd|rd|th)")
   ) -> number_of_infected_leaves_or_berries

## Merge data and compute serverity per branchs
number_of_infected_leaves_or_berries %>%
  left_join(total_number_of_leaves_or_berries, by = join_by("sample_code" == "sample_code",
                                                            "branch" == "branch",
                                                            "portion" == "portion",
                                                            "organ" == "organ")) %>%
  mutate(severity = infected_count/total_count) %>%
  left_join(covariate_data, by = "sample_code") %>%
  mutate(Shade_tree_species = as.factor(Shade_tree_species)) %>%
  rename(distance = "Actual_distance_from_shade_tree_m") %>%
  mutate(distance_class = cut(
      distance,
      breaks = c(0, 8, 16, 24),  # Specify the breakpoints for distance class
      labels = c("[0-8]", "(8-16]", "(16-22]"),  # Labels for each range
      right = F), # Indicates whether intervals are right-closed
    total_count = case_when(total_count > 250 ~ round(total_count/10), # correct error (5 branch have more than 150 leaves -> error due to one digit added when tipping)
                            .default = total_count),
    log_total_count = log(total_count),
    across(where(is.character),~as.factor(.x))) -> data_severity

## Tree with no leaves (to remove)
data_severity%>%
  group_by(sample_code)%>%
  summarise(total_count = sum(total_count, na.rm = T)) %>%
  filter(total_count ==0) %>%
  pull(sample_code)-> no_leave_trees
```

## 2.3 Data cleaning
before removing tree with no leaves
```{r}
data_incidence %>%
  group_by(Shade_tree_species, disease) %>%
  mutate(n_tot = n(),
            infected_count = sum(true_incidence,na.rm  =T)) %>%
  ggplot()+
  facet_wrap(~disease) +
  geom_bar(aes(Shade_tree_species, fill = as.factor(true_incidence)), position = "fill") +
  geom_text(aes(x=Shade_tree_species, y=0.2,group = Shade_tree_species, label = infected_count), col = "white") +
  geom_text(aes(x=Shade_tree_species, y=1.04,group = Shade_tree_species, label = n_tot)) +
  scale_fill_startrek() +
  labs(x = " Shade tree", y = "Proportion", fill = "Incidence") +
  main_theme +
    theme(
        axis.text.x = element_text(colour = "black", size=14, face="italic", angle = 45, vjust = 1, hjust = 1))

data_incidence %>%
  group_by(Shade_tree_species, Coffee_Variety,disease) %>%
  mutate(n_tot = n(),
            infected_count = sum(true_incidence,na.rm  =T)) %>%
  ggplot()+
  facet_wrap(~Coffee_Variety*disease) +
  geom_bar(aes(Shade_tree_species, fill = as.factor(true_incidence)), position = "fill") +
  geom_text(aes(x=Shade_tree_species, y=0.2,group = Shade_tree_species, label = infected_count), col = "white") +
  geom_text(aes(x=Shade_tree_species, y=1.04,group = Shade_tree_species, label = n_tot)) +
  scale_fill_startrek() +
  labs(x = " Shade tree", y = "Proportion", fill = "Incidence") +
  main_theme
```

after removing tree with no leaves
```{r}
data_incidence %>%
  filter(!(sample_code %in% no_leave_trees)) -> data_incidence

data_incidence %>%
  group_by(Shade_tree_species, disease) %>%
  mutate(n_tot = n(),
            infected_count = sum(true_incidence,na.rm  =T)) %>%
  ggplot()+
  facet_wrap(~disease) +
  geom_bar(aes(Shade_tree_species, fill = as.factor(true_incidence)), position = "fill") +
  geom_text(aes(x=Shade_tree_species, y=0.2,group = Shade_tree_species, label = infected_count), col = "white") +
  geom_text(aes(x=Shade_tree_species, y=1.04,group = Shade_tree_species, label = n_tot)) +
  scale_fill_startrek() +
  labs(x = " Shade tree", y = "Proportion", fill = "Incidence") +
  main_theme +
    theme(
        axis.text.x = element_text(colour = "black", size=14, face="italic", angle = 45, vjust = 1, hjust = 1))
data_incidence %>%
  group_by(Shade_tree_species, Coffee_Variety,disease) %>%
  mutate(n_tot = n(),
            infected_count = sum(true_incidence,na.rm  =T)) %>%
  ggplot()+
  facet_wrap(~Coffee_Variety*disease) +
  geom_bar(aes(Shade_tree_species, fill = as.factor(true_incidence)), position = "fill") +
  geom_text(aes(x=Shade_tree_species, y=0.2,group = Shade_tree_species, label = infected_count), col = "white") +
  geom_text(aes(x=Shade_tree_species, y=1.04,group = Shade_tree_species, label = n_tot)) +
  scale_fill_startrek() +
  labs(x = " Shade tree", y = "Proportion", fill = "Incidence") +
  main_theme
```

before removing clone H and D

```{r}
data_incidence %>%
  filter( disease == "CWD") %>%
  group_by(Shade_tree_species, Coffee_Variety) %>%
  mutate(n_tot = n(),
            infected_count = sum(true_incidence,na.rm  =T)) %>%
  ggplot()+
  facet_wrap(~Coffee_Variety) +
  geom_bar(aes(Shade_tree_species, fill = as.factor(true_incidence)), position = "fill") +
  geom_text(aes(x=Shade_tree_species, y=0.2,group = Shade_tree_species, label = infected_count), col = "white") +
  geom_text(aes(x=Shade_tree_species, y=1.04,group = Shade_tree_species, label = n_tot)) +
  scale_fill_startrek() +
  labs(x = " Shade tree", y = "Proportion", fill = "Incidence") +
  main_theme
```

after removing clone H and D
```{r}
 data_incidence %>%
  filter(!(Coffee_Variety %in% c("Clone H", "Clone D"))) %>%
   mutate(Coffee_Variety  = as.factor(as.character(Coffee_Variety))) -> data_incidence
data_incidence %>%
  filter( disease == "CWD") %>%
  group_by(Shade_tree_species, Coffee_Variety) %>%
  mutate(n_tot = n(),
            infected_count = sum(true_incidence,na.rm  =T)) %>%
  ggplot()+
  facet_wrap(~Coffee_Variety) +
  geom_bar(aes(Shade_tree_species, fill = as.factor(true_incidence)), position = "fill") +
  geom_text(aes(x=Shade_tree_species, y=0.2,group = Shade_tree_species, label = infected_count), col = "white") +
  geom_text(aes(x=Shade_tree_species, y=1.04,group = Shade_tree_species, label = n_tot)) +
  scale_fill_startrek() +
  labs(x = " Shade tree", y = "Proportion", fill = "Incidence") +
  main_theme
```

```{r include=FALSE}
data_severity %>%
  filter(!(sample_code %in% no_leave_trees))%>%
  filter(!(Coffee_Variety %in% c("Clone H", "Clone D"))) %>%
   mutate(Coffee_Variety  = as.factor(as.character(Coffee_Variety))) -> data_severity
```



# 3 Incidence model
### 3.2 CWD incidence data
```{r}
# Create a function that take input for a glm creation. Give back the model and residuals informations.
incidence.mod.func <- function(data, 
                              frml){ # Formula for fixed effect of the models
  # Compute the model
  mod_severity <-  glmmTMB(formula = formula(frml),
                              family = binomial(),# Incidence is 1 or 0 (win or lose trial) => binomial family
                              data = data)
  # Compute residuals
  res_severity <- DHARMa::simulateResiduals(mod_severity, plot = TRUE)


  par(mfrow = c(2, 3))
  
  # Plot to check if dispersion term or zero inflation term is needed
  testDispersion(res_severity)
  testZeroInflation(res_severity)
  
  # Plot residuals against some variables
  plotResiduals(res_severity, form = data$distance )
  plotResiduals(res_severity, form = data$Shade_tree_species)
  plotResiduals(res_severity, form = data$Section_of_kawerie)
  plotResiduals(res_severity, form = data$Coffee_Variety)
  par(mfrow = c(1, 1))
  
  return(mod_severity)
}
```

#### Compute models

Try different model, the only constrain is that we keep "distance*Shade_tree_species + (1|Shade_tree_soil_sample_CODE)" .
"distance*Shade_tree_species" : are main effect and interaction in which we are interested 
"Shade_tree_soil_sample_CODE" : mixte effect to correct autocorrelation at the shade tree level. Because quantity of infected shrubs influenced around a shade tree due to variable that act locally and that we don't control.
```{r}

data_incidence %>%
  filter(disease == "CWD") -> binary_data_CWD

## Compute binomial glm  
binary_data_CWD %>%
  incidence.mod.func(frml = "true_incidence ~ Shade_tree_species * distance + (1|Shade_tree_soil_sample_CODE)") -> mod_binary_incidence_CWD
binary_data_CWD %>%
  incidence.mod.func(frml = "true_incidence ~ Shade_tree_species * distance + (1|Shade_tree_soil_sample_CODE)") -> mod_binary_incidence_CWD1
binary_data_CWD %>%
  incidence.mod.func(frml = "true_incidence ~ Shade_tree_species * distance  + Coffee_Variety +
                                  (1|Shade_tree_soil_sample_CODE)") -> mod_binary_incidence_CWD2
binary_data_CWD %>%
  incidence.mod.func(frml = "true_incidence ~ Shade_tree_species * (distance + Coffee_Variety) +
                                   (1|Shade_tree_soil_sample_CODE)") -> mod_binary_incidence_CWD3
binary_data_CWD %>%
  incidence.mod.func(frml = "true_incidence ~ Shade_tree_species * (distance + Coffee_Variety )+
                                  distance:Coffee_Variety  + (1|Shade_tree_soil_sample_CODE)") -> mod_binary_incidence_CWD4
binary_data_CWD %>%
  incidence.mod.func(frml = "true_incidence ~ Shade_tree_species * distance * Coffee_Variety +
                                    + (1|Shade_tree_soil_sample_CODE)") -> mod_binary_incidence_CWD5
```
We could do a model with a interaction with all the variable (Shade_tree_species * distance * Coffee_Variety). It work but a 3 interaction term require to estimate Ã  large quantity of parameter. I don't think we have enough data (of incidence) to estimate well those parameters.

```{r}
AIC(mod_binary_incidence_CWD1,
    mod_binary_incidence_CWD2,
    mod_binary_incidence_CWD3,
    mod_binary_incidence_CWD4,
    mod_binary_incidence_CWD5)
```


**The model : glm(formula = Incidence_CWD \~ Shade_tree_species\*distance + Coffee_Variety, family = binomial )**

```{r}
## Anova 
car::Anova(mod_binary_incidence_CWD2, 2) %>%
  round(2)
car::Anova(mod_binary_incidence_CWD2, 3)

r2_nakagawa(mod_binary_incidence_CWD2)
summary(mod_binary_incidence_CWD2)
```

Tendency of Coffee variety on Incidence of CWD, I'm doing a postHoc pairwise comparison to see if there are some difference between varieties.

#### Plot results

```{r}
# Function to get significance letter from a contrast dataframe (pairwise comparison dataframe)
get_significance_letters <- function(contrast_df, alpha = 0.05, level_col1 = "Level1", level_col2 = "Level2", p_col = "p") {
  # Extract levels
  all_levels <- unique(c(as.character(contrast_df[[level_col1]]), as.character(contrast_df[[level_col2]])))

  # Initialize an empty matrix of p-values
  pmat <- matrix(NA, nrow = length(all_levels), ncol = length(all_levels),
                 dimnames = list(all_levels, all_levels))

  # Fill in the matrix with provided p-values
  for (i in seq_len(nrow(contrast_df))) {
    l1 <- as.character(contrast_df[[level_col1]][i])
    l2 <- as.character(contrast_df[[level_col2]][i])
    pval <- contrast_df[[p_col]][i]
    pmat[l1, l2] <- pval
    pmat[l2, l1] <- pval
  }
  # Generate letters using multcompView
  comp <- multcompView::multcompLetters(pmat<0.05,compare = "<")$Letters

  # Prepare output dataframe
  output <- data.frame(
    variable = factor(names(comp), levels = all_levels),
    .group = comp,
    stringsAsFactors = FALSE
  )

  return(output)
}
```


```{r}
# Here I'm using "interactions" package instead of "ggeffect." When we predict the full model "ggeffect" don't separate partial residual depending, I don't know why. 

interactions::interact_plot(mod_binary_incidence_CWD2, pred = distance, modx =Shade_tree_species ,
              mod2 =Coffee_Variety,
              colors = "Set1",
              interval = T, plot.points = T, data = binary_data_CWD, partial.residuals = F,
              point.size = 3, 
              line.thickness = 1.5,
              alpha=0.4,
              vary.lty = F) +
  facet_grid(cols = vars(Coffee_Variety), row = vars(Shade_tree_species))+
  scale_y_continuous(limits = c(0,1))+
  labs(x = "Distance from shade tree (m)") +
  theme_classic()+
  theme(aspect.ratio = 1,
        plot.margin = margin(0, 0, 0, 0),
        axis.title.y = element_blank(),
        axis.text.y = element_blank(),
        strip.text.x = element_blank(),
        strip.text.y = element_blank(),
        legend.position = "None",
        panel.border = element_rect(colour = "black", fill = NA, linewidth = 1),
        axis.title.x = element_text(colour = "black", size=14, face="italic")) -> p1

# "interactions"  package can only make prediction by fixing non used predictor to the fist level for factor variable so now I'm using "ggeffect" to average prediction across all factors (with margin = empirical, see package description for more details).

ggeffects::predict_response(mod_binary_incidence_CWD2, c("distance[all]", "Shade_tree_species"), margin = "empirical") %>% 
  plot(show_data =T,show_ci=T, show_title = F,
        dot_size  = 3, 
        dot_alpha = 0.4,
        line_size  = 1.5) +
  facet_grid(row = vars(group),switch="both") +
  scale_y_continuous(limits = c(0,1))+
  labs(x = "Distance from shade tree (m)", y = "CWD incidence probability") +
  theme_classic()+
  theme(aspect.ratio = 1,
        plot.margin = margin(0, 0, 0, 0),
        axis.title.x = element_blank(),
        legend.position = "None",
        panel.border = element_rect(colour = "black", fill = NA, linewidth = 1),
        axis.title.y = element_text(colour = "black", size=14, face="italic")) -> p2

ggeffects::predict_response(mod_binary_incidence_CWD2, c("distance[all]", "Coffee_Variety"), margin = "empirical") %>%
  plot(show_data =T,show_ci=T, show_title = F,
        colors = rep("black", 6),
        dot_size  = 3, 
        dot_alpha = 0.4,
        line_size  = 1.5,
        grid = T) +
  scale_y_continuous(limits = c(0,1))+
  facet_grid(cols = vars(group)) +
  labs(y = "CWD incidence probability") +
  theme_classic()+
  theme(aspect.ratio = 1,
        plot.margin = margin(0, 0, 0, 0),
        legend.position = "None",
        axis.title = element_blank(),
        axis.text = element_blank(),
        panel.border = element_rect(colour = "black", fill = NA, linewidth = 1)) -> p3

ggeffect::predict_response(mod_binary_incidence_CWD2, c("distance[all]"), margin = "empirical") %>%
  plot(show_data =T,show_ci=T, show_title = F,
        dot_size  = 3, 
        dot_alpha = 0.4,
        line_size  = 1.5) +
  scale_y_continuous(limits = c(0,1))+
  theme_classic()+
  theme(aspect.ratio = 1,
        plot.margin = margin(0, 0, 0, 0),
        legend.position = "None",
        axis.title = element_blank(),
        axis.text = element_blank(),
        panel.border = element_rect(colour = "black", fill = NA, linewidth = 1)) -> p4



modelbased::estimate_contrasts(mod_binary_incidence_CWD2 ,
                               "Coffee_Variety", estimate = "typical", p_adjust = "fdr") -> contrast_incidence_variety_df

get_significance_letters(contrast_incidence_variety_df) %>%
  mutate(variable = factor(variable , levels = levels(data_incidence$Coffee_Variety))) %>%
  arrange(variable) %>%
  mutate(x= as.numeric(variable))-> compl_letter_incidence_var

modelbased::estimate_means(mod_binary_incidence_CWD2,"Coffee_Variety",estimate = "typical") -> incidence_variety

incidence_variety %>% 
  as.data.frame() %>%
  ggplot() +
    geom_pointrange(
    aes(x= Coffee_Variety , y = Probability , ymin = CI_low, ymax = CI_high),
    size = 0.75,linewidth = 1
  ) +
  geom_text(data = compl_letter_incidence_var, aes(x = x, y =0.95, label = .group), vjust = 0) +
  scale_y_continuous(limits = c(0,1)) +
  labs(x= "Coffee Varieties", y = "Incidence probability") +
  theme_classic() +
  theme(aspect.ratio = 1,
        axis.line = element_line(colour = "black"),
        panel.border = element_blank(),
        axis.ticks =  element_line(colour = "black"),
        axis.text.x = element_text(colour = "black", size=13, face="italic", angle = -10, vjust = 0, hjust =0.5),
        axis.text.y = element_text(colour = "black", size=13, face="italic"),
        legend.text = element_text(colour = "black", size=18),
        axis.title= element_text(size=16,face="bold"),
        strip.text = element_text(colour = "black", size=15, face ="italic")) -> p5

p5

layout <- c(
  area(t = 0, l = 0, b = 2, r = 3.5),
  area(t = 3, l = 2, b = 10, r = 10),
  area(t = 3, l = 0, b = 10, r = 3.5),
  area(t = 0, l = 2, b = 2, r = 10)
)
p4 + p1 + p2 + p3+
  plot_layout(design = layout)

#Slope pairwise comparison shade tree
modelbased::estimate_slopes(mod_binary_incidence_CWD2, trend = "distance", by = "Shade_tree_species")

layout2 <- c(
  area(t = 0, l = 0, b =10, r = 3.5),
  area(t = 0, l = 2, b = 10, r = 10)
)
p2+theme(axis.title.x =  element_text(size=16,face="bold"),
         axis.title.y =  element_text(size=16,face="bold"))+
  p5+theme(axis.title.y = element_blank())+
  plot_layout(design = layout2) &
  theme(plot.tag.position  = c(0.25, 1),
        plot.tag = element_text(size=16,face="italic"))&
  plot_annotation(tag_levels = 'A')
  
```


### 4.4 Recap incidence : graph

```{r}
data_incidence %>%
  filter( disease == "CRBD") %>%
  group_by(Shade_tree_species, Coffee_Variety) %>%
  mutate(n_tot = n(),
            infected_count = sum(true_incidence,na.rm  =T)) %>%
  ggplot()+
  facet_wrap(~Coffee_Variety) +
  geom_bar(aes(Shade_tree_species, fill = as.factor(true_incidence)), position = "fill") +
  geom_text(aes(x=Shade_tree_species, y=0.2,group = Shade_tree_species, label = infected_count), col = "white") +
  geom_text(aes(x=Shade_tree_species, y=1.04,group = Shade_tree_species, label = n_tot)) +
  scale_fill_startrek() +
  labs(x = " Shade tree", y = "Proportion", fill = "Incidence") +
  main_theme

data_incidence %>%
  filter( disease == "CWD") %>%
  group_by(Shade_tree_species, Coffee_Variety) %>%
  mutate(n_tot = n(),
            infected_count = sum(true_incidence,na.rm  =T)) %>%
  ggplot()+
  facet_wrap(~Coffee_Variety) +
  geom_bar(aes(Shade_tree_species, fill = as.factor(true_incidence)), position = "fill") +
  geom_text(aes(x=Shade_tree_species, y=0.2,group = Shade_tree_species, label = infected_count), col = "white") +
  geom_text(aes(x=Shade_tree_species, y=1.04,group = Shade_tree_species, label = n_tot)) +
  scale_fill_startrek() +
  labs(x = " Shade tree", y = "Proportion", fill = "Incidence") +
  main_theme

data_incidence %>%
  filter( disease == "CLR") %>%
  group_by(Shade_tree_species, Coffee_Variety) %>%
  mutate(n_tot = n(),
            infected_count = sum(true_incidence,na.rm  =T)) %>%
  ggplot()+
  facet_wrap(~Coffee_Variety) +
  geom_bar(aes(Shade_tree_species, fill = as.factor(true_incidence)), position = "fill") +
  geom_text(aes(x=Shade_tree_species, y=0.2,group = Shade_tree_species, label = infected_count), col = "white") +
  geom_text(aes(x=Shade_tree_species, y=1.04,group = Shade_tree_species, label = n_tot)) +
  scale_fill_startrek() +
  labs(x = " Shade tree", y = "Proportion", fill = "Incidence") +
  main_theme

data_incidence %>%
 
  mutate(Shade_tree_species) %>%
  group_by(Shade_tree_species, disease) %>%
  mutate(n_tot = n(),
            infected_count = sum(true_incidence,na.rm  =T)) %>%
   mutate(true_incidence = case_when(true_incidence == 1 ~ "Present",
                                    true_incidence == 0 ~ "Absent")) %>%
  ggplot()+
  facet_wrap(~disease) +
  geom_bar(aes(Shade_tree_species, fill = as.factor(true_incidence)), position = "fill") +
  geom_text(aes(x=Shade_tree_species, y=0.2,group = Shade_tree_species, label = infected_count), col = "white") +
  geom_text(aes(x=Shade_tree_species, y=1.04,group = Shade_tree_species, label = n_tot)) +
  scale_fill_startrek() +
  labs(x = " Shade tree species", y = "Proportion of coffee shrubs", fill = "Lesion incidence") +
  theme_minimal()+
  theme(aspect.ratio = 1,
      axis.line = element_line(colour = "black"),
      panel.border = element_blank(),
      axis.ticks =  element_line(colour = "black"),
      axis.text.x = element_text(colour = "black", size=13, face="italic"),
      axis.text.y = element_text(colour = "black", size=13, face="italic"),
      legend.title = element_text(colour = "black", size=20, hjust =0.5),
      legend.text = element_text(colour = "black", size=13),
      axis.title= element_text(size=16,face="bold"),
      strip.text = element_text(colour = "black", size=15, face ="italic"))

data_incidence %>%
  group_by(Coffee_Variety, disease) %>%
  mutate(n_tot = n(),
            infected_count = sum( true_incidence,na.rm  =T)) %>%
  ggplot()+
  facet_wrap(~disease) +
  geom_bar(aes(Coffee_Variety, fill = as.factor(true_incidence)), position = "fill") +
  geom_text(aes(x=Coffee_Variety, y=0.2,group = Coffee_Variety, label = infected_count), col = "white") +
  geom_text(aes(x=Coffee_Variety, y=1.04,group = Coffee_Variety, label = n_tot)) +
  scale_fill_startrek() +
  labs(x = " Coffee Variety", y = "Proportion", fill = "Incidence") +
  main_theme

```

# 4 Severity model

## 4.1 Severity correlation between diseases

```{r echo=FALSE}
data_severity %>%
  filter(organ != "berries") %>%
   dplyr::select(severity, sample_code, disease,branch,portion) %>%
  pivot_wider(names_from = disease, values_from = severity) %>% 
  dplyr::select(CWD, CLR, CRBD, portion) %>%
  ggpairs(columns = 1:3,
          mapping = ggplot2::aes(color = portion,
                                
                                 alpha =1),
          diag = list(continuous = wrap("barDiag", alpha=0.5 )),
          upper = list(continuous = wrap("cor", size = 5))) +
  labs(x = "Severity", y = "Severity/branch count")+
  scale_color_lancet()+
  scale_fill_lancet()+
  theme_classic() +
  theme (axis.line = element_line(colour = "black"),
        axis.ticks =  element_line(colour = "black"),
        legend.text = element_text(colour = "black", size=18),
        axis.title= element_text(size=16,face="bold"),
        strip.text = element_text(colour = "black", size=15, face ="italic"),
        panel.border = element_rect(colour = "black", fill = NA, linewidth = 1))
```





### 4.2  severity model and residual function
```{r include=FALSE}

severity.mod.func <- function(data, 
                              frml,
                              zifrml,
                              disprml = formula("~1")){
 
  mod_severity <-  glmmTMB(formula = frml,
                              ziformula = zifrml,
                              dispformula = disprml,
                              family = beta_family(),
                              #weights = total_count ,
                              data = data)

  res_severity <- DHARMa::simulateResiduals(mod_severity, plot = TRUE)


  par(mfrow = c(2, 3))
  testDispersion(res_severity)
  testZeroInflation(res_severity)
  plotResiduals(res_severity, form = data$distance )
  plotResiduals(res_severity, form = data$Shade_tree_species)
  plotResiduals(res_severity, form = data$log_total_count)
  plotResiduals(res_severity, form = data$Coffee_Variety)
  par(mfrow = c(1, 1))
  
  return(mod_severity)
}

```

## 4.3 CRBD LEAVES severity model

```{r include=FALSE}
data_severity %>%
  filter(disease == "CRBD", organ =="leaves") %>%
  filter(!(Coffee_Variety %in% c("Clone H", "Clone D"))) %>%
  mutate(Coffee_Variety = as.factor(as.character(Coffee_Variety))) -> data_severity_CRBD_leaves

data_severity_CRBD_leaves %>%
  ggplot() +
  geom_point(aes(x = log_total_count, y = severity))
```

### Compute models

```{r include=FALSE}
data_severity_CRBD_leaves %>%
  filter(portion =="Top", !is.na(severity)) %>%
  mutate(severity = case_when(severity == 1 ~ 0.999,
                              .default = severity))-> CRBD_leaves_top
CRBD_leaves_top%>%
  severity.mod.func(frml = formula("severity ~ Shade_tree_species *distance   + (1|Shade_tree_soil_sample_CODE)"),
                    zifrml = formula("~1")) -> mod_severity_CRBD_leaves_top

CRBD_leaves_top%>%
  severity.mod.func(frml = formula("severity ~ Shade_tree_species*distance   + Coffee_Variety +
                                            (1|Shade_tree_soil_sample_CODE)"),
                    zifrml = formula("~1")) -> mod_severity_CRBD_leaves_top2
CRBD_leaves_top%>%
  severity.mod.func(frml = formula("severity ~ Shade_tree_species*distance   + Coffee_Variety +
                                            (1|Shade_tree_soil_sample_CODE)"),
                              zifrml = formula("~Coffee_Variety")) -> mod_severity_CRBD_leaves_top3
CRBD_leaves_top%>%
  severity.mod.func(frml = formula("severity ~ Shade_tree_species*distance   + 
                                            (1|Shade_tree_soil_sample_CODE)"),
                              zifrml = formula("~Coffee_Variety ")) -> mod_severity_CRBD_leaves_top4
CRBD_leaves_top%>%
  severity.mod.func(frml = formula("severity ~ Shade_tree_species*distance   +
                                            (1|Shade_tree_soil_sample_CODE)"),
                    zifrml = formula("~Coffee_Variety"),
                    disprml = formula("~Coffee_Variety")) -> mod_severity_CRBD_leaves_top5
CRBD_leaves_top%>%
  severity.mod.func(frml = formula("severity ~ Shade_tree_species*distance +
                                            (1|Shade_tree_soil_sample_CODE)"),
                    zifrml = formula("~Coffee_Variety"),
                    disprml = formula("~log_total_count")) -> mod_severity_CRBD_leaves_top6
CRBD_leaves_top%>%
  severity.mod.func(frml = formula("severity ~ Shade_tree_species*distance +
                                            (1|Shade_tree_soil_sample_CODE)"),
                    zifrml = formula("~Shade_tree_species"),
                    disprml = formula("~log_total_count")) -> mod_severity_CRBD_leaves_top6_test
CRBD_leaves_top%>%
  severity.mod.func(frml = formula("severity ~ Shade_tree_species*distance + Coffee_Variety +
                                            (1|Shade_tree_soil_sample_CODE)"),
                    zifrml = formula("~Coffee_Variety"),
                    disprml = formula("~log_total_count")) -> mod_severity_CRBD_leaves_top8
CRBD_leaves_top%>%
  severity.mod.func(frml = formula("severity ~ Shade_tree_species*distance + Coffee_Variety +
                                            (1|Shade_tree_soil_sample_CODE)"),
                    zifrml = formula("~Coffee_Variety"),
                    disprml = formula("~Coffee_Variety")) -> mod_severity_CRBD_leaves_top9
CRBD_leaves_top%>%
  severity.mod.func(frml = formula("severity ~ Shade_tree_species*distance + Coffee_Variety + Coffee_Variety:distance +
                                            (1|Shade_tree_soil_sample_CODE)"),
                    zifrml = formula("~Coffee_Variety"),
                    disprml = formula("~log_total_count")) -> mod_severity_CRBD_leaves_top8_bis
CRBD_leaves_top%>%
  severity.mod.func(frml = formula("severity ~ Shade_tree_species*distance + Coffee_Variety + Coffee_Variety:distance +
                                            (1|Shade_tree_soil_sample_CODE)"),
                    zifrml = formula("~Coffee_Variety"),
                    disprml = formula("~Coffee_Variety")) -> mod_severity_CRBD_leaves_top9_bis
CRBD_leaves_top%>%
  severity.mod.func(frml = formula("severity ~ Shade_tree_species*(distance + Coffee_Variety) +
                                            (1|Shade_tree_soil_sample_CODE)"),
                    zifrml = formula("~Coffee_Variety"),
                    disprml = formula("~log_total_count")) -> mod_severity_CRBD_leaves_top10
CRBD_leaves_top%>%
  severity.mod.func(frml = formula("severity ~ Shade_tree_species*(distance + Coffee_Variety) +
                                            (1|Shade_tree_soil_sample_CODE)"),
                    zifrml = formula("~Coffee_Variety"),
                    disprml = formula("~Coffee_Variety")) -> mod_severity_CRBD_leaves_top11
CRBD_leaves_top%>%
  severity.mod.func(frml = formula("severity ~ Shade_tree_species*(distance + Coffee_Variety) + distance:Coffee_Variety+
                                            (1|Shade_tree_soil_sample_CODE)"),
                    zifrml = formula("~Coffee_Variety"),
                    disprml = formula("~log_total_count")) -> mod_severity_CRBD_leaves_top12
CRBD_leaves_top%>%
  severity.mod.func(frml = formula("severity ~ Shade_tree_species*(distance + Coffee_Variety) + distance:Coffee_Variety+
                                            (1|Shade_tree_soil_sample_CODE)"),
                    zifrml = formula("~Coffee_Variety"),
                    disprml = formula("~Coffee_Variety")) -> mod_severity_CRBD_leaves_top13

# convegence issues
CRBD_leaves_top%>%
  severity.mod.func(frml = formula("severity ~ Shade_tree_species*distance * Coffee_Variety +
                                            (1|Shade_tree_soil_sample_CODE)"),
                    zifrml = formula("~Coffee_Variety"),
                    disprml = formula("~log_total_count")) -> mod_severity_CRBD_leaves_top14

CRBD_leaves_top%>%
  severity.mod.func(frml = formula("severity ~ Shade_tree_species*distance * Coffee_Variety +
                                            (1|Shade_tree_soil_sample_CODE)"),
                    zifrml = formula("~Coffee_Variety"),
                    disprml = formula("~Coffee_Variety")) -> mod_severity_CRBD_leaves_top15

## Some models I've tested, either bad residuals or to complex to interpret
# CRBD_leaves_top%>%
#   severity.mod.func(frml = formula("severity ~ Shade_tree_species*distance+
#                                             (1|Shade_tree_soil_sample_CODE)"),
#                     zifrml = formula("~Coffee_Variety"),
#                     disprml = formula("~log_total_count*Coffee_Variety")) -> mod_severity_CRBD_leaves_top10
# CRBD_leaves_top%>%
#   severity.mod.func(frml = formula("severity ~ Shade_tree_species*(distance+Coffee_Variety)+
#                                             (1|Shade_tree_soil_sample_CODE)"),
#                     zifrml = formula("~Coffee_Variety"),
#                     disprml = formula("~log_total_count*Coffee_Variety")) -> mod_severity_CRBD_leaves_top11
# CRBD_leaves_top%>%
#   severity.mod.func(frml = formula("severity ~ Shade_tree_species*(distance+Coffee_Variety) + distance:Coffee_Variety+
#                                             (1|Shade_tree_soil_sample_CODE)"),
#                     zifrml = formula("~Coffee_Variety"),
#                     disprml = formula("~log_total_count*Coffee_Variety")) -> mod_severity_CRBD_leaves_top12
# 
# CRBD_leaves_top%>%
#   severity.mod.func(frml = formula("severity ~ Shade_tree_species*distance+
#                                             (1|Shade_tree_soil_sample_CODE)"),
#                     zifrml = formula("~Coffee_Variety"),
#                     disprml = formula("~log_total_count+Coffee_Variety")) -> mod_severity_CRBD_leaves_top10_bis
# CRBD_leaves_top%>%
#   severity.mod.func(frml = formula("severity ~ Shade_tree_species*(distance+Coffee_Variety)+
#                                             (1|Shade_tree_soil_sample_CODE)"),
#                     zifrml = formula("~Coffee_Variety"),
#                     disprml = formula("~log_total_count+Coffee_Variety")) -> mod_severity_CRBD_leaves_top11_bis
# 
# CRBD_leaves_top%>%
#   severity.mod.func(frml = formula("severity ~ Shade_tree_species*(distance+Coffee_Variety) + distance:Coffee_Variety+
#                                             (1|Shade_tree_soil_sample_CODE)"),
#                     zifrml = formula("~Coffee_Variety"),
#                     disprml = formula("~log_total_count+Coffee_Variety")) -> mod_severity_CRBD_leaves_top12_bis


```


Coffee variety or log(total leaf) are mandatory to correct for dispersion

### Model selection

```{r}
AIC(mod_severity_CRBD_leaves_top5,
    mod_severity_CRBD_leaves_top6,
    #mod_severity_CRBD_leaves_top7,
    mod_severity_CRBD_leaves_top8,
    mod_severity_CRBD_leaves_top9,
    mod_severity_CRBD_leaves_top8_bis,
    mod_severity_CRBD_leaves_top9_bis,
    mod_severity_CRBD_leaves_top10,
    mod_severity_CRBD_leaves_top11,
    mod_severity_CRBD_leaves_top12,
    mod_severity_CRBD_leaves_top13)
```

### Model's estimations

```{r}
# Anova
Anova(mod_severity_CRBD_leaves_top6) %>%
  round(2)
Anova(mod_severity_CRBD_leaves_top6, 3) %>%
  round(2)

Anova(mod_severity_CRBD_leaves_top6, component = "zi") 

Anova(mod_severity_CRBD_leaves_top6, component = "disp")
r.squaredGLMM(mod_severity_CRBD_leaves_top6)
r2_nakagawa(mod_severity_CRBD_leaves_top6,
            null_model =   glmmTMB(formula = severity~1,
                              ziformula = ~0,
                              
                              family = beta_family(),
                              #weights = total_count ,
                              data = CRBD_leaves_top))
summary(mod_severity_CRBD_leaves_top6)
```


```{r}
modelbased::estimate_contrasts(mod_severity_CRBD_leaves_top6,"Coffee_Variety",estimate = "typical", p_adjust = "fdr") -> contrast_CRBD_severity_variety_df
get_significance_letters(contrast_CRBD_severity_variety_df) %>%
  mutate(variable = factor(variable , levels = levels(CRBD_leaves_top$Coffee_Variety))) %>%
  arrange(variable) %>%
  mutate(x= as.numeric(variable))-> compl_letter_CRBD_severity_var

modelbased::estimate_means(mod_severity_CRBD_leaves_top6,"Coffee_Variety",estimate = "typical") -> CRBD_severity_variety
ggplot(CRBD_severity_variety, aes(x = Coffee_Variety, y = Proportion)) +
  geom_pointrange(aes(ymin = CI_low, ymax = CI_high), linewidth = 1) +
   geom_text(data = compl_letter_CRBD_severity_var, aes(x = x, y =0.15, label = .group), vjust = 0)+
  labs(x= "Variety", y = "CRBD severity")+
  theme_classic()+
  theme(aspect.ratio = 1,
        axis.text.x = element_text(colour = "black", size=13, face="italic", angle = 18, vjust =1, hjust =1),
        axis.text.y = element_text(colour = "black", size=13, face="italic"),
        axis.title = element_text(colour = "black", size=16)) -> p_CRBD_severity_variety

p_CRBD_severity_variety
```

-   **Coffee variety influence probability of CRBD lesion absence at the branch level**
-   Distance alone doesn't influence significantly CRBD severity.
-   Shade trees doesn't influence significantly CRBD severity.
-   Interaction between Shade trees and distance doesn't influence significantly CRBD severity.

## 4.4 CWD severity model

```{r include=FALSE}
data_severity %>%
  filter(disease == "CWD") -> data_severity_CWD
```

### Compute models

```{r include=FALSE}
# Models
data_severity_CWD %>%
  filter(portion =="Top", !is.na(severity)) %>%
  mutate(severity = case_when(severity == 1 ~ 0.999,
                              .default = severity))-> CWD_top

CWD_top%>%
  severity.mod.func(frml = formula("severity ~ Shade_tree_species*distance + (1|Shade_tree_soil_sample_CODE)"),
                    zifrml =  formula("~1")) -> mod_severity_CWD_top


CWD_top%>%
  severity.mod.func(frml = formula("severity ~ Shade_tree_species*distance   + Coffee_Variety + 
                                            (1|Shade_tree_soil_sample_CODE)"),
                     zifrml =  formula("~1")) -> mod_severity_CWD_top2
CWD_top%>%
  severity.mod.func(frml = formula("severity ~ Shade_tree_species*distance+(distance*Coffee_Variety) +
                                   (1|Shade_tree_soil_sample_CODE)"),
                    zifrml =  formula("~1")) -> mod_severity_CWD_top2_bis
CWD_top%>%
  severity.mod.func(frml = formula("severity ~ Shade_tree_species*distance  + 
                                            (1|Shade_tree_soil_sample_CODE)"),
                              zifrml = formula("~Coffee_Variety")) -> mod_severity_CWD_top3
CWD_top%>%
  severity.mod.func(frml = formula("severity ~ Shade_tree_species*distance   + Coffee_Variety + 
                                            (1|Shade_tree_soil_sample_CODE)"),
                              zifrml = formula("~Coffee_Variety")) -> mod_severity_CWD_top4
CWD_top%>%
  severity.mod.func(frml = formula("severity ~ Shade_tree_species*distance  + 
                                            (1|Shade_tree_soil_sample_CODE)"),
                              zifrml = formula("~Shade_tree_species")) -> mod_severity_CWD_top5
CWD_top%>%
  severity.mod.func(frml = formula("severity ~ Shade_tree_species*distance  + 
                                            (1|Shade_tree_soil_sample_CODE)"),
                              zifrml = formula("~log_total_count")) -> mod_severity_CWD_top6
CWD_top%>%
  severity.mod.func(frml = formula("severity ~ Shade_tree_species*distance + Coffee_Variety+
                                            (1|Shade_tree_soil_sample_CODE)"),
                              zifrml = formula("~Coffee_Variety"),
                              disprml= formula("~log_total_count"))-> mod_severity_CWD_top7
CWD_top%>%
  severity.mod.func(frml = formula("severity ~ Shade_tree_species*distance + Coffee_Variety+Coffee_Variety:distance+
                                            (1|Shade_tree_soil_sample_CODE)"),
                              zifrml = formula("~Coffee_Variety"),
                              disprml= formula("~log_total_count"))-> mod_severity_CWD_top8

### adding more to the model lead to non-convergence issues
CWD_top%>%
  severity.mod.func(frml = formula("severity ~ Shade_tree_species*distance*Coffee_Variety +
                                   (1|Shade_tree_soil_sample_CODE)"),
                    zifrml =  formula("~1")) -> mod_severity_CWD_top9
CWD_top%>%
  severity.mod.func(frml = formula("severity ~ Shade_tree_species*(distance + Coffee_Variety) +
                                            (1|Shade_tree_soil_sample_CODE)"),
                              zifrml = formula("~Coffee_Variety"),
                              disprml= formula("~log_total_count"))-> mod_severity_CWD_top10
```

### Model selection

```{r}
# dplyr::select model
AIC(mod_severity_CWD_top,
    mod_severity_CWD_top2_bis,
    mod_severity_CWD_top6,
    mod_severity_CWD_top7, 
    mod_severity_CWD_top8) %>%
  round(1)
```
### Model's estimations

```{r}
# Anova Model 4

Anova(mod_severity_CWD_top8) %>%
  round(2)
Anova(mod_severity_CWD_top8,component = "zi") %>%
  round(2)
Anova(mod_severity_CWD_top8,component = "disp") %>%
  round(2)
Anova(mod_severity_CWD_top8, "III") %>%
  round(2)


modelbased::estimate_slopes(mod_severity_CWD_top8, "distance",by = "Coffee_Variety") %>% 
  as.data.frame() %>%
  ggplot() +
  geom_pointrange(aes(y = Coffee_Variety, x = Slope, xmin = CI_low, xmax = CI_high),cex = 0.7, linewidth = 1) +
  geom_vline(xintercept = 0, cex = 1, linetype = 3, color = "red") +
  #facet_grid(rows = vars(type), scales = "free_y")+
  labs(x= "Estimated distance slopes for CWD severity", y = "Coffee varieties", col = "Slope type")+
  scale_color_d3()+
  theme_classic()+
  theme(aspect.ratio = 1,
        
        axis.text.x = element_text(colour = "black", size=13, face="italic", angle = 18, vjust =1, hjust =1),
        axis.text.y = element_text(colour = "black", size=13, face="italic"),
        axis.title = element_text(colour = "black", size=16),
        panel.border = element_rect(colour = "black", fill = NA, linewidth = 1),
        legend.title = element_text(colour = "black", size=16,
                                    hjust =0.5),
        legend.text = element_text(colour = "black", size=13)) -> p_CWD_trend_variety
p_CWD_trend_variety

predict_response(mod_severity_CWD_top8, c("distance[all]", "Coffee_Variety"), type = "fixed", margin = "empirical") -> temp

temp %>% plot(show_data = F) +
  facet_wrap(~group)


modelbased::estimate_contrasts(mod_severity_CWD_top8,"Coffee_Variety",estimate = "typical", p_adjust = "fdr") -> contrast_CWD_severity_variety_df
get_significance_letters(contrast_CWD_severity_variety_df) %>%
  mutate(variable = factor(variable , levels = levels(data_severity_CWD$Coffee_Variety))) %>%
  arrange(variable) %>%
  mutate(x= as.numeric(variable))-> compl_letter_CWD_severity_var

modelbased::estimate_means(mod_severity_CWD_top8,"Coffee_Variety",estimate = "typical") -> CWD_severity_variety
ggplot(CWD_severity_variety, aes(x = Coffee_Variety, y = Proportion)) +
  geom_pointrange(aes(ymin = CI_low, ymax = CI_high), linewidth = 1) +
   geom_text(data = compl_letter_CWD_severity_var, aes(x = x, y =0.05, label = .group), vjust = 0)+
  labs(x= "Variety", y = "CWD severity")+
  theme_classic()+
  theme(aspect.ratio = 1,
        axis.text.x = element_text(colour = "black", size=13, face="italic", angle = 18, vjust =1, hjust =1),
        axis.text.y = element_text(colour = "black", size=13, face="italic"),
        axis.title = element_text(colour = "black", size=16)) -> p_CWD_severity_variety

p_CWD_severity_variety
```

AIC of model 1 4 and 5 aren't different enough to conclude which model is the more parsimonious (delta\<2)

-   **On the model 4 tendency of Coffee variety CWD lesion absence, but pairwise comparison show no effect**
-   Distance alone doesn't influence significantly CWD severity.
-   Shade trees doesn't influence significantly CWD severity.
-   Interaction between Shade trees and distance doesn't influence significantly CWD severity.

## 4.5 CLR severity model

```{r include=FALSE}
data_severity %>%
  filter(disease == "CLR",
        !(Coffee_Variety %in% c("Clone H", "Clone D"))) %>%
  mutate(Coffee_Variety = as.factor(as.character(Coffee_Variety)))-> data_severity_CLR
```

### Compute models

```{r include=FALSE}
# Models
data_severity_CLR %>%
  filter(portion == "lower", !is.na(severity)) %>%
  mutate(severity = case_when(severity == 1 ~ severity*0.999,
                              .default = severity)) -> CLR_low

CLR_low %>%
 severity.mod.func(frml = formula("severity ~ Shade_tree_species*distance + 
                                            (1|Shade_tree_soil_sample_CODE)"),
                   zifrml =  formula("~1")) -> mod_severity_CLR_low
CLR_low %>%
 severity.mod.func(frml = formula("severity ~ Shade_tree_species*distance   + Coffee_Variety + 
                                            (1|Shade_tree_soil_sample_CODE)"),
                   zifrml = formula("~1")) -> mod_severity_CLR_low2

CLR_low %>%
 severity.mod.func(frml = formula("severity ~ Shade_tree_species*distance    + 
                                            (1|Shade_tree_soil_sample_CODE)"),
                   zifrml = formula("~Coffee_Variety")) -> mod_severity_CLR_low3
CLR_low %>%
 severity.mod.func(frml = formula("severity ~ Shade_tree_species*distance    + Coffee_Variety+
                                            (1|Shade_tree_soil_sample_CODE)"),
                   zifrml = formula("~Coffee_Variety")) -> mod_severity_CLR_low4
CLR_low%>%
  severity.mod.func(frml = formula("severity ~ Shade_tree_species*distance + 
                                            (1|Shade_tree_soil_sample_CODE)"),
                    zifrml = formula("~Shade_tree_species")) -> mod_severity_CLR_low5
CLR_low%>%
  severity.mod.func(frml = formula("severity ~ Shade_tree_species*distance + Coffee_Variety+
                                            (1|Shade_tree_soil_sample_CODE)"),
                    zifrml = formula("~Shade_tree_species")) -> mod_severity_CLR_low6

CLR_low %>%
 severity.mod.func(frml = formula("severity ~ Shade_tree_species*distance + Coffee_Variety +
                                            (1|Shade_tree_soil_sample_CODE)"),
                    zifrml = formula("~Coffee_Variety"),
                    disprml =formula("~Coffee_Variety") ) -> mod_severity_CLR_low7

CLR_low %>%
 severity.mod.func(frml = formula("severity ~ Shade_tree_species*distance + Coffee_Variety +
                                            (1|Shade_tree_soil_sample_CODE)"),
                    zifrml = formula("~Coffee_Variety"),
                    disprml =formula("~log_total_count") ) -> mod_severity_CLR_low8

CLR_low %>%
 severity.mod.func(frml = formula("severity ~ Shade_tree_species*distance + Coffee_Variety*distance +
                                            (1|Shade_tree_soil_sample_CODE)"),
                    zifrml = formula("~Coffee_Variety"),
                    disprml =formula("~log_total_count") ) -> mod_severity_CLR_low9
CLR_low %>%
 severity.mod.func(frml = formula("severity ~ Shade_tree_species*distance + Coffee_Variety*distance + Shade_tree_species:Coffee_Variety +
                                            (1|Shade_tree_soil_sample_CODE)"),
                    zifrml = formula("~Coffee_Variety"),
                    disprml =formula("~log_total_count")) -> mod_severity_CLR_low10

CLR_low %>%
 severity.mod.func(frml = formula("severity ~ Shade_tree_species*distance *Coffee_Variety+
                                            (1|Shade_tree_soil_sample_CODE)"),
                    zifrml = formula("~Coffee_Variety"),
                    disprml =formula("~log_total_count") ) -> mod_severity_CLR_low11

## Some models I've tested, either bad residuals or to complex to interpret
# CLR_low %>%
#  severity.mod.func(frml = formula("severity ~ Shade_tree_species*distance *Coffee_Variety+
#                                             (1|Shade_tree_soil_sample_CODE)"),
#                     zifrml = formula("~Coffee_Variety"),
#                     disprml =formula("~log_total_count+Coffee_Variety")) -> mod_severity_CLR_low12
# CLR_low %>%
#  severity.mod.func(frml = formula("severity ~ Shade_tree_species*distance *Coffee_Variety+ Shade_tree_species:Coffee_Variety +
#                                             (1|Shade_tree_soil_sample_CODE)"),
#                     zifrml = formula("~Coffee_Variety"),
#                     disprml =formula("~log_total_count+Coffee_Variety")) -> mod_severity_CLR_low13
# CLR_low %>%
#  severity.mod.func(frml = formula("severity ~  Shade_tree_species*distance + Coffee_Variety*distance +
#                                             (1|Shade_tree_soil_sample_CODE)"),
#                     zifrml = formula("~Coffee_Variety"),
#                     disprml =formula("~log_total_count*Coffee_Variety")) -> mod_severity_CLR_low14
# CLR_low %>%
#  severity.mod.func(frml = formula("severity ~  Shade_tree_species*distance + Coffee_Variety*distance + Shade_tree_species:Coffee_Variety +
#                                             (1|Shade_tree_soil_sample_CODE)"),
#                     zifrml = formula("~Coffee_Variety"),
#                     disprml =formula("~log_total_count*Coffee_Variety")) -> mod_severity_CLR_low15
# CLR_low %>%
#  severity.mod.func(frml = formula("severity ~ Shade_tree_species*distance *Coffee_Variety+
#                                             (1|Shade_tree_soil_sample_CODE)"),
#                     zifrml = formula("~Coffee_Variety"),
#                     disprml =formula("~log_total_count*Coffee_Variety")) -> mod_severity_CLR_low16

```

### Model selection

```{r}
AIC(mod_severity_CLR_low8,mod_severity_CLR_low10)
# Anova
Anova(mod_severity_CLR_low8) %>%
  round(2) 
Anova(mod_severity_CLR_low8,component = "zi") %>%
  round(2) 
Anova(mod_severity_CLR_low8,component = "disp") %>%
  round(2)

```

### Model's estimation

```{r}
predict_response(mod_severity_CLR_low8, c("distance[all]", "Shade_tree_species","Coffee_Variety"),
                 margin = "empirical",type = "zero_inflated") -> prediction_clr_all

prediction_clr_all %>%
  plot(show_data =T,show_ci=T, show_title = F,
        dot_size  = 3, 
        dot_alpha = 0.05,
        line_size  = 1.5) +
  facet_grid(cols = vars(facet), row = vars(group))+
  scale_y_continuous(limits = c(0,1))+
  labs(x = "Distance from shade tree (m)") +
  theme_classic()+
  theme(aspect.ratio = 1,
        plot.margin = margin(0, 0, 0, 0),
        axis.title.y = element_blank(),
        axis.text.y = element_blank(),
        strip.text.x = element_blank(),
        strip.text.y = element_blank(),
        legend.position = "None",
        panel.border = element_rect(colour = "black", fill = NA, linewidth = 1),
        axis.title.x = element_text(colour = "black", size=14, face="italic")) -> p1_clr

predict_response(mod_severity_CLR_low8, c("distance[all]", "Shade_tree_species"), 
                 margin = "empirical",type = "zero_inflated") -> prediction_clr_dist_shade

prediction_clr_dist_shade%>%
  plot(show_data =T,show_ci=T, show_title = F,
        dot_size  = 3, 
        dot_alpha = 0.05,
        line_size  = 1.5) +
  facet_grid(row = vars(group),switch="both") +
  scale_y_continuous(limits = c(0,1))+
  labs(x = "Distance from shade tree (m)", y = "CLR severity") +
  theme_classic()+
  theme(aspect.ratio = 1,
        plot.margin = margin(0, 0, 0, 0),
        axis.title.x = element_blank(),
        legend.position = "None",
        panel.border = element_rect(colour = "black", fill = NA, linewidth = 1),
        axis.title.y = element_text(colour = "black", size=14, face="italic")) -> p2_clr

predict_response(mod_severity_CLR_low8, c("distance[all]", "Coffee_Variety"),
                 margin = "empirical") -> prediction_clr_dist_var

prediction_clr_dist_var %>%
  plot(show_data =T,show_ci=T, show_title = F,
        colors = rep("black", 6),
        dot_size  = 3, 
        dot_alpha = 0.05,
        line_size  = 1.5,
        grid = T) +
  scale_y_continuous(limits = c(0,1))+
  facet_grid(cols = vars(group)) +
  labs(y = "CLR incidence probability") +
  theme_classic()+
  theme(aspect.ratio = 1,
        plot.margin = margin(0, 0, 0, 0),
        legend.position = "None",
        axis.title = element_blank(),
        axis.text = element_blank(),
        panel.border = element_rect(colour = "black", fill = NA, linewidth = 1)) -> p3_clr

predict_response(mod_severity_CLR_low8, c("distance[all]"),
                 margin = "empirical") -> prediction_clr_dist
prediction_clr_dist %>%
  plot(show_data =T,show_ci=T, show_title = F,
        dot_size  = 3, 
        dot_alpha = 0.05,
        line_size  = 1.5) +
  scale_y_continuous(limits = c(0,1))+
  theme_classic()+
  theme(aspect.ratio = 1,
        plot.margin = margin(0, 0, 0, 0),
        legend.position = "None",
        axis.title = element_blank(),
        axis.text = element_blank(),
        panel.border = element_rect(colour = "black", fill = NA, linewidth = 1)) -> p4_clr
```


```{r}
modelbased::estimate_contrasts(mod_severity_CLR_low8,"Coffee_Variety",estimate = "typical", p_adjust = "fdr") -> contrast_CLR_severity_variety_df
get_significance_letters(contrast_CLR_severity_variety_df) %>%
  mutate(variable = factor(variable , levels = levels(data_severity_CLR$Coffee_Variety))) %>%
  arrange(variable) %>%
  mutate(x= as.numeric(variable))-> compl_letter_CLR_severity_var

modelbased::estimate_means(mod_severity_CLR_low8,"Coffee_Variety",estimate = "typical") -> CLR_severity_variety
CLR_severity_variety %>%
  ggplot(aes(x = Coffee_Variety, y = Proportion)) +
  geom_pointrange(aes(ymin = CI_low, ymax = CI_high), linewidth = 1) +
  scale_y_continuous(limits = c(0,0.5))+
  geom_text(data = compl_letter_CLR_severity_var, aes(x = x, y =0.45, label = .group), vjust = 0)+
  labs(x= "Variety", y = "CLR severity")+
  theme_classic()+
  theme(aspect.ratio = 1,
        axis.text.x = element_text(colour = "black", size=13, face="italic", angle = 18, vjust =1, hjust =1),
        axis.text.y = element_text(colour = "black", size=13, face="italic"),
        axis.title = element_text(colour = "black", size=16)) -> p_CLR_severity_variety

p_CLR_severity_variety

```


```{r}
modelbased::estimate_contrasts(mod_severity_CLR_low8, "Shade_tree_species", estimate = "typical", p_adjust = "fdr") -> contrast_CLR_severity_shade_df
get_significance_letters(contrast_CLR_severity_shade_df) %>%
  mutate(variable = factor(variable , levels = levels(data_severity_CLR$Shade_tree_species))) %>%
  arrange(variable) %>%
  mutate(x= as.numeric(variable))-> compl_letter_CLR_severity_shade

modelbased::estimate_means(mod_severity_CLR_low8,"Shade_tree_species",estimate = "typical") -> CLR_severity_shade
CLR_severity_shade %>%
  ggplot(aes(x = Shade_tree_species, y = Proportion)) +
  geom_pointrange(aes(ymin = CI_low, ymax = CI_high), linewidth = 1) +
  scale_y_continuous(limits = c(0,0.5))+
  geom_text(data = compl_letter_CLR_severity_shade, aes(x = x, y =0.45, label = .group), vjust = 0)+
  labs(x= "Shade tree species", y = "CLR severity")+
  theme_classic()+
  theme(aspect.ratio = 1,
        axis.text.x = element_text(colour = "black", size=13, face="italic", angle = 18, vjust =1, hjust =1),
        axis.text.y = element_text(colour = "black", size=13, face="italic"),
        axis.title = element_text(colour = "black", size=16)) -> p_CLR_severity_variety

p_CLR_severity_variety

```


```{r}
layout <- c(
  area(t = 0, l = 0, b = 2, r = 3.5),
  area(t = 3, l = 2, b = 10, r = 10),
  area(t = 3, l = 0, b = 10, r = 3.5),
  area(t = 0, l = 3, b = 2, r = 9)
)

p4_clr + p1_clr + p2_clr + p3_clr+
  plot_layout(design = layout)
```


```{r}
#Slope contrast

modelbased::estimate_slopes(mod_severity_CLR_low8,trend = "distance", by = "Shade_tree_species") %>%
  as.data.frame %>%
  rename(factors = "Shade_tree_species") %>%
  mutate(type = "Shade tree : Distance") -> clr_trend_shade

# modelbased::estimate_slopes(mod_severity_CLR_low8,trend = "distance", by = "Coffee_Variety") %>%
#   as.data.frame %>%
#   rename(factors = "Coffee_Variety") %>%
#   mutate(type = "Coffee variety : Distance") -> clr_trend_var

modelbased::estimate_slopes(mod_severity_CLR_low8,trend = "distance") %>%
  as.data.frame %>%
  mutate(type = "Distance alone",
         factors ="Distance") -> clr_trend

clr_trend_shade %>%
  #bind_rows(clr_trend_var) %>%
  bind_rows(clr_trend) %>%
  mutate(factors = factor(factors, levels = c(as.character(clr_trend_shade$factors),
                                           #as.character(clr_trend_var$factors),
                                           as.character(clr_trend$factors))),
         type = factor(type, levels = c("Distance alone",
                                        "Coffee variety : Distance",
                                        "Shade tree : Distance"))) %>%
  ggplot() +
  geom_pointrange(aes(y = factors, x = Slope, xmin = CI_low, xmax = CI_high, colour = type),cex = 0.7, linewidth = 1) +
  geom_vline(xintercept = 0, linewidth = 1, linetype = 3, color = "red") +
  #facet_grid(rows = vars(type), scales = "free_y")+
  labs(x= "Estimated distance slopes for CLR severity", col = "Slope type")+
  scale_color_d3()+
  theme_classic()+
  theme(aspect.ratio = 1,
        axis.title.y = element_blank(),
        axis.text.x = element_text(colour = "black", size=13, face="italic", angle = 18, vjust =1, hjust =1),
        axis.text.y = element_text(colour = "black", size=13, face="italic"),
        axis.title = element_text(colour = "black", size=16),
        panel.border = element_rect(colour = "black", fill = NA, linewidth = 1),
        legend.title = element_text(colour = "black", size=16,
                                    hjust =0.5),
        legend.text = element_text(colour = "black", size=13)) -> p_crl_trend
p_crl_trend
```


```{r}
CRBD_severity_variety %>%
  as.data.frame %>%
  mutate(disease = "CRBD") -> CRBD_sev_var_temp
CWD_severity_variety%>%
  as.data.frame %>%
  mutate(disease = "CWD") -> CWD_sev_var_temp
CLR_severity_variety%>%
  as.data.frame %>%
  mutate(disease = "CLR") -> CLR_sev_var_temp
str(data_severity)
CRBD_sev_var_temp %>%
  bind_rows(CWD_sev_var_temp) %>%
  bind_rows(CLR_sev_var_temp) %>%
  ggplot() +
  geom_violin(data = data_severity %>%
                dplyr::filter(organ=="leaves"), aes(x = Coffee_Variety, y=severity, fill = disease), 
               position = position_dodge(width=0.6),alpha = 0.3, color = "white",scale = "width") +
  geom_pointrange(aes(x = Coffee_Variety, y =   Proportion, ymin = CI_low, ymax = CI_high, colour = disease),
                   position = position_dodge(width=0.6),  cex = 0.7, linewidth = 1) +
  geom_text(data = compl_letter_CLR_severity_var, aes(x = x-0.2, y =CLR_sev_var_temp$Proportion+0.06, label = .group), vjust = 0)+
  geom_text(data = compl_letter_CRBD_severity_var, aes(x = x, y =CRBD_sev_var_temp$Proportion+0.06, label = .group), vjust = 0)+
  geom_text(data = compl_letter_CWD_severity_var, aes(x = x+0.2, y =CWD_sev_var_temp$Proportion+0.06, label = .group), vjust = 0)+
 
  #scale_y_continuous(limits = c(0,0.5))+
  labs(x = "Coffee Varieties", y =  "Severity", col = "Diseases", fill = "Diseases")+
  scale_color_bmj()+
  scale_fill_bmj()+
  theme_classic()+
  theme(aspect.ratio = 1,
        axis.text.x = element_text(colour = "black", size=13, face="italic", angle = 18, vjust =1, hjust =1),
        axis.text.y = element_text(colour = "black", size=13, face="italic"),
        axis.title = element_text(colour = "black", size=16),
        panel.border = element_rect(colour = "black", fill = NA, linewidth = 1),
        legend.title = element_text(colour = "black", size=16,
                                    hjust =0.5),

        legend.text = element_text(colour = "black", size=13)) -> severity_variety

# (((p_CRBD_severity_variety + theme(axis.title.x = element_blank(), axis.text.x= element_blank()))  / 
#     (p_CWD_severity_variety + theme(axis.title.x= element_blank(), axis.text.x= element_blank())) /
#     p_CLR_severity_variety +
#     plot_layout(guides = 'auto')) | severity_variety) + plot_layout(guides = 'collect')
severity_variety

p_CRBD_severity_variety + theme(axis.title.x = element_blank(), axis.text.x= element_blank()) +
  p_CWD_severity_variety + theme(axis.title.x= element_blank(), axis.text.x= element_blank()) +
  p_CLR_severity_variety +
  severity_variety +
  plot_layout(nrow=2)

p_CWD_trend_variety

#save.image(file = "outputs/image.Rdata")
```

