---
title: "Untitled"
author: "Mathis Gheno"
date: "2024-12-05"
output: html_document
editor_options: 
  chunk_output_type: inline
---

## 1 Load Packages
```{r setup, include=FALSE}
library(tidyverse)
library(readxl)
library(ggsci)

library(car)
library(glmmTMB)
library(effects)
library(ggeffects)
library(DHARMa)

library(sf)

main_theme = theme_minimal()+
  theme(line = element_blank(), 
        axis.line = element_line(colour = "black"),
        panel.border = element_blank(),
        axis.ticks =  element_line(colour = "black"),
        axis.text.x = element_text(colour = "black", size=22, face="italic", angle = 45, vjust = 1, hjust = 1),
        axis.text.y = element_text(colour = "black", size=22, face="italic"),
        legend.title = element_text(colour = "black", size=20,
                                    hjust =0.5),

        legend.text = element_text(colour = "black", size=18),
        axis.title= element_text(size=28),
        strip.text = element_text(colour = "black", size=15, face ="italic"))

convert_dms_to_dd <- function(dms) {
  if(is.na(dms)){
    return(NA)
  }
  if(str_detect(dms, "^\\d+$")){
    return(NA)
  } else{
  dms <- str_replace_all(dms, "[°′″’']", " ") # Replace degree, minute, and second symbols with spaces
  dms_split <- str_split(dms, "\\s+")[[1]]  # Split the string into components
  degrees <- as.numeric(dms_split[1])
  minutes <- as.numeric(dms_split[2])
  seconds <- as.numeric(dms_split[3])
  direction <- dms_split[4]
  
  # Calculate decimal degrees
  decimal_degrees <- degrees + minutes / 60 + seconds / 3600
  if (direction %in% c("S", "W")) {
    decimal_degrees <- -decimal_degrees
  }
  return(decimal_degrees)
  }
}

```

## 2 Arrange data to long format

```{r}
data <- read_xlsx("data/R_PhD_Data_corrected.xlsx")
data %>% filter(is.na(Shade_tree_Canopy_Cover))
data %>%
  rename(sample_code = "Coffee_soil _sample_CODE") %>%
  mutate(sample_code = paste(sample_code,
                             str_extract(Section_of_Kaweri, "^[a-zA-Z]{4}"), sep = "_"),
         Shade_tree_soil_sample_CODE = paste(Shade_tree_soil_sample_CODE,
                             str_extract(Section_of_Kaweri, "^[a-zA-Z]{4}"), sep = "_")) -> data



covariate_data <- data %>%
  select(Shade_tree_species, Section_of_Kaweri, sample_code, Coffee_Variety,
         Actual_distance_from_shade_tree_m, Shade_tree_Canopy_Cover, Shade_tree_soil_sample_CODE,
         Longitude, Latitude) %>% 
  mutate(Coffee_Variety = case_when(is.na(Coffee_Variety) ~"unknown_var",
                                    .default = Coffee_Variety)) %>%
  ## A little trick to remove na from Shade_tree_Canopy_Cover
  group_by(Shade_tree_soil_sample_CODE) %>%
  mutate(Shade_tree_Canopy_Cover = mean(Shade_tree_Canopy_Cover, na.rm = T),
          Longitude = ifelse(is.na(Longitude), first(na.omit(Longitude)), Longitude),
          Latitude = ifelse(is.na(Latitude), first(na.omit(Latitude)), Latitude),
          Longitude_dd = ifelse(!is.na(Longitude), sapply(Longitude, convert_dms_to_dd), NA),
          Latitude_dd = ifelse(!is.na(Latitude), sapply(Latitude, convert_dms_to_dd), NA),
          
          ) %>%
  ungroup() 

 data %>% 
  select(sample_code, starts_with("inc"), starts_with("Inc")) %>%
  pivot_longer(-sample_code, values_to = "value", names_to = "value_type") %>%
  mutate(
    # Extracting "disease" (e.g., "CWD", "CLR", "CRBD")
    disease = str_extract(value_type, "(?<=_)[A-Z]+"),
    
    # Extracting "portion"
    portion = str_extract(value_type, "(?<=_)lower|Top|middle"),
    
    # Extracting "branch" (e.g., "1st", "2nd", "3rd", "4th")
    branch = str_extract(value_type, "\\d+(st|nd|rd|th)"),
    
    # Extracting "value_type" (e.g., "incidence" or "Incidence")
    value_type = str_extract(value_type, "^[^_]+"),
    
    # change "Incidence"  to "incidence")
    value_type = str_replace_all(value_type, "Incidence", "incidence")
  ) %>%
  mutate(value = ifelse(value>=1,1,0 )) %>%
  left_join(covariate_data, by = "sample_code") %>%
  group_by(sample_code, disease) %>% # sample code are the ID to individual coffee tree
  summarise(true_incidence = ifelse(sum(value, na.rm = T)>=1,1,0), # 0 occurrence = 0 ; 1 to 12 occurrence = 1
            n =  n(),
            distance = unique(Actual_distance_from_shade_tree_m),
            Shade_tree_species = unique(Shade_tree_species),
            Shade_tree_Canopy_Cover =  unique(Shade_tree_Canopy_Cover),
            Shade_tree_soil_sample_CODE = unique(Shade_tree_soil_sample_CODE),
            Coffee_Variety = unique(Coffee_Variety)) %>%
   ungroup() -> data_incidence

```

## 3 Covariate
```{r}
library(GGally)
covariate_data %>%
  select(Actual_distance_from_shade_tree_m, Shade_tree_Canopy_Cover) %>%
  mutate(Actual_distance_from_shade_tree_m_exp  =exp(Actual_distance_from_shade_tree_m),
         Shade_tree_Canopy_Cover_exp = exp(Shade_tree_Canopy_Cover)) %>%
  ggpairs()
```

```{r}
coord <- covariate_data %>%
  select(Latitude_dd, Longitude_dd, Shade_tree_soil_sample_CODE,Longitude, Latitude)

 coord %>% 
  group_by(Latitude_dd, Longitude_dd) %>% 
  filter(n() > 1) 

 coord %>% 
  unique() %>%
  group_by(Latitude_dd, Longitude_dd) %>% 
  filter(n() > 1) -> temp
ggplot(coord) +
  geom_point(aes(Latitude_dd , Longitude_dd ))
#   # Convert coordinates to sf object with EPSG:4326 CRS
# df_sf <- st_as_sf(coord, coords = c("Latitude_dd", "Longitude_dd"), crs = 4326, na.fail = F)
# 
# # Transform to EPSG:3857 CRS
# df_3857 <- st_transform(df_sf, 3857)
# 
# df_3857 %>%
#     distinct(Shade_tree_soil_sample_CODE, .keep_all = TRUE) %>%
#     st_write("coordinate_shade_tree.shp")
#  covariate_data %>%
#    filter(is.na(Shade_tree_Canopy_Cover)) %>% pull(Shade_tree_soil_sample_CODE) %>% unique()
```

## 4 Incidence model

### 4.1 CRBD incidence data

#### Shade tree

```{r}
data_incidence %>%
  filter(disease == "CRBD") -> binary_data_CRBD
## Compute binomial glm  
mod_binary_incidence_CRBD <- glmmTMB(formula = true_incidence ~ Shade_tree_species*distance , # + Coffee_Variety (don't work)
                              family = binomial,
                              data = binary_data_CRBD)

res_incidence_CRBD<- DHARMa::simulateResiduals(mod_binary_incidence_CRBD, plot = TRUE)
testDispersion(res_incidence_CRBD)
testZeroInflation(res_incidence_CRBD)


## Anova of type 2 and 3 are more robust that basic anova 
car::Anova(mod_binary_incidence_CRBD, 2)
car::Anova(mod_binary_incidence_CRBD, 3)

##
summ_mod_CRBD <- summary(mod_binary_incidence_CRBD)
summ_mod_CRBD

plot(allEffects(mod_binary_incidence_CRBD,response = "link", residuals = T,se = F))
## Basic graphic
binary_data_CRBD%>%
  ggplot()+
  facet_wrap(~Shade_tree_species) +
  geom_smooth(aes(distance, true_incidence), method = "glm", method.args = list(family=binomial), se = TRUE) +
  geom_point( aes(distance, true_incidence)) +

  labs(y = "Infection proportion CRBD" ) +
  theme_classic()

binary_data_CRBD%>%
  ggplot()+
  facet_wrap(~Shade_tree_species) +
  geom_smooth(aes(distance, true_incidence), method = "glm", method.args = list(family=binomial), se = TRUE) +
  geom_point( aes(distance, true_incidence)) +

  labs(y = "Infection proportion CRBD" ) +
  theme_classic()
```
No effect (see anova)

#### Canopy cover

```{r}
## Compute binomial glm  
mod_binary_incidence_CRBD_canop <- glmmTMB(formula = true_incidence ~ Shade_tree_Canopy_Cover*distance, # + Coffee_Variety (don't work)
                              family = binomial,
                              data = binary_data_CRBD)

res_incidence_CRBD_canop<- DHARMa::simulateResiduals(mod_binary_incidence_CRBD_canop, plot = TRUE)
testDispersion(res_incidence_CRBD_canop)
testZeroInflation(res_incidence_CRBD_canop)


## Anova of type 2 and 3 are more robust that basic anova 
car::Anova(mod_binary_incidence_CRBD_canop, 2)
car::Anova(mod_binary_incidence_CRBD_canop, 3)

##
summ_mod_CRBD_canop <- summary(mod_binary_incidence_CRBD_canop)
summ_mod_CRBD_canop

plot(allEffects(mod_binary_incidence_CRBD_canop,response = "link", residuals = T))
## Basic graphic
binary_data_CRBD%>%
  ggplot()+

  geom_smooth(aes(distance, true_incidence), method = "glm", method.args = list(family=binomial), se = TRUE) +
  geom_point( aes(distance, true_incidence)) +
  labs(y = "Infection proportion CRBD" ) +
  theme_classic()

binary_data_CRBD%>%
  ggplot()+
  geom_smooth(aes(Shade_tree_Canopy_Cover, true_incidence), method = "glm", method.args = list(family=binomial), se = TRUE) +
  geom_point( aes(Shade_tree_Canopy_Cover, true_incidence)) +

  labs(y = "Infection proportion CRBD" ) +
  theme_classic()
```

#### Coffee var

```{r}

## Compute binomial glm  
mod_binary_incidence_CRBD_variety <- glmmTMB(formula = true_incidence ~ Coffee_Variety ,
                              family = binomial,
                              data = binary_data_CRBD)

res_incidence_CRBD_variety<- DHARMa::simulateResiduals(mod_binary_incidence_CRBD_variety, plot = TRUE)
testDispersion(res_incidence_CRBD_variety)
testZeroInflation(res_incidence_CRBD_variety)


## Anova of type 2 and 3 are more robust that basic anova 
car::Anova(mod_binary_incidence_CRBD_variety, 2)
car::Anova(mod_binary_incidence_CRBD_variety, 3)

##
summ_mod_CRBD <- summary(mod_binary_incidence_CRBD_variety)
summ_mod_CRBD

plot(allEffects(mod_binary_incidence_CRBD_variety,response = "link", residuals = T,se = F))
## Basic graphic
binary_data_CRBD%>%
  ggplot() +
  geom_bar(aes(Coffee_Variety, fill = as.factor(true_incidence)),position = "fill") +

  labs(y = "Infection proportion CRBD" ) +
  theme_classic()
```

### 4.2 CWD incidence data

#### Shade tree

```{r}
## Arrange the data like I've explained bellow 
data_incidence %>%
  filter(disease == "CWD")  -> binary_data_CWD

## Compute binomial glm  
mod_binary_incidence_CWD <- glmmTMB(formula = true_incidence ~ Shade_tree_species*distance + Coffee_Variety,
                              family = binomial,
                              data = binary_data_CWD)

res_incidence_CWD<- DHARMa::simulateResiduals(mod_binary_incidence_CWD, plot = TRUE)
testDispersion(res_incidence_CWD)
testZeroInflation(res_incidence_CWD)

## Anova of type 2 and 3 are more robust that basic anova 
car::Anova(mod_binary_incidence_CWD, 2)
car::Anova(mod_binary_incidence_CWD, 3)

##
summ_mod_CWD <- summary(mod_binary_incidence_CWD)
summ_mod_CWD

plot(allEffects(mod_binary_incidence_CWD, residuals = T))
## Basic graphic
binary_data_CWD%>%
  ggplot()+
 
  geom_smooth(aes(distance, true_incidence), method = "glm",
              method.args = list(family=binomial), se = TRUE) +
  geom_point( aes(distance, true_incidence)) +

  labs(y = "Infection proportion CWD" ) +
  theme_classic()
```
No effect (see anova)

#### Canopy cover

```{r}
## Compute binomial glm  
mod_binary_incidence_CWD_canop <- glmmTMB(formula = true_incidence ~ Shade_tree_Canopy_Cover*distance  + Coffee_Variety,
                              family = binomial,
                              data = binary_data_CWD)

res_incidence_CWD_canop<- DHARMa::simulateResiduals(mod_binary_incidence_CWD_canop, plot = TRUE)
testDispersion(res_incidence_CWD_canop)
testZeroInflation(res_incidence_CWD_canop)


## Anova of type 2 and 3 are more robust that basic anova 
car::Anova(mod_binary_incidence_CWD_canop, 2)
car::Anova(mod_binary_incidence_CWD_canop, 3)

##
summ_mod_CWD_canop <- summary(mod_binary_incidence_CWD_canop)
summ_mod_CWD_canop

plot(allEffects(mod_binary_incidence_CWD_canop,response = "link", residuals = T,se = F))
## Basic graphic
binary_data_CWD%>%
  ggplot()+

  geom_smooth(aes(distance, true_incidence), method = "glm", method.args = list(family=binomial), se = TRUE) +
  geom_point( aes(distance, true_incidence)) +
  labs(y = "Infection proportion CWD" ) +
  theme_classic()

binary_data_CWD%>%
  ggplot()+
  geom_smooth(aes(Shade_tree_Canopy_Cover, true_incidence), method = "glm", method.args = list(family=binomial), se = TRUE) +
  geom_point( aes(Shade_tree_Canopy_Cover, true_incidence)) +

  labs(y = "Infection proportion CWD" ) +
  theme_classic()
```

#### Coffee var

```{r}

## Compute binomial glm  
mod_binary_incidence_CWD_variety <- glmmTMB(formula = true_incidence ~ Coffee_Variety ,
                              family = binomial,
                              data = binary_data_CWD)

res_incidence_CWD_variety<- DHARMa::simulateResiduals(mod_binary_incidence_CWD_variety, plot = TRUE)
testDispersion(res_incidence_CWD_variety)
testZeroInflation(res_incidence_CWD_variety)


## Anova of type 2 and 3 are more robust that basic anova 
car::Anova(mod_binary_incidence_CWD_variety, 2)
car::Anova(mod_binary_incidence_CWD_variety, 3)

##
summ_mod_CWD <- summary(mod_binary_incidence_CWD_variety)
summ_mod_CWD

plot(allEffects(mod_binary_incidence_CWD_variety,response = "link", residuals = T,se = F))
## Basic graphic
binary_data_CWD%>%
  ggplot() +
  geom_bar(aes(Coffee_Variety, fill = as.factor(true_incidence)),position = "fill") +

  labs(y = "Infection proportion CWD" ) +
  theme_classic()
```


### 4.3 CLR incidence data

#### Shade tree

```{r}
## Arrange the data like I've explained bellow 

data_incidence %>%
  filter(disease == "CLR") -> binary_data_CLR
## Compute binomial glm  
mod_binary_incidence_CLR <- glmmTMB(formula = true_incidence ~ Shade_tree_species*distance, # + Coffee_Variety (don't work)
                              family = binomial,
                              data = binary_data_CLR)


res_incidence_CLR<- DHARMa::simulateResiduals(mod_binary_incidence_CLR, plot = TRUE)
testDispersion(res_incidence_CLR)
testZeroInflation(res_incidence_CLR)


## Anova of type 2 and 3 are more robust that basic anova 
car::Anova(mod_binary_incidence_CLR, 2)
car::Anova(mod_binary_incidence_CLR, 3)

##
summ_mod_CLR <- summary(mod_binary_incidence_CLR)
summ_mod_CLR

#(just an example on how to compute probability of occurrence of the disease. Those formula should only be computed with significant parameters)
plogis(3.35040 +(16.21567-0.37268)*20) # Artocarpus heterophyllus at 20m 

plot(allEffects(mod_binary_incidence_CLR, residuals = T))

## Basic graphic
binary_data_CLR%>%
  ggplot()+
  facet_wrap(~Shade_tree_species) +
  geom_smooth(aes(distance, true_incidence), method = "glm", method.args = list(family=binomial), se = TRUE) +
  geom_point( aes(distance, true_incidence)) +

  labs(y = "Infection proportion CLR" ) +
  theme_classic()
```
No effect (see anova)

#### Canopy cover

```{r}
## Compute binomial glm  
mod_binary_incidence_CLR_canop <- glmmTMB(formula = true_incidence ~ Shade_tree_Canopy_Cover*distance,  # + Coffee_Variety (don't work)
                              family = binomial,
                              data = binary_data_CLR)

res_incidence_CLR_canop<- DHARMa::simulateResiduals(mod_binary_incidence_CLR_canop, plot = TRUE)
testDispersion(res_incidence_CLR_canop)
testZeroInflation(res_incidence_CLR_canop)


## Anova of type 2 and 3 are more robust that basic anova 
car::Anova(mod_binary_incidence_CLR_canop, 2)
car::Anova(mod_binary_incidence_CLR_canop, 3)

##
summ_mod_CLR_canop <- summary(mod_binary_incidence_CLR_canop)
summ_mod_CLR_canop

plot(allEffects(mod_binary_incidence_CLR_canop,response = "link", residuals = T,se = F))
## Basic graphic
binary_data_CLR%>%
  ggplot()+

  geom_smooth(aes(distance, true_incidence), method = "glm", method.args = list(family=binomial), se = TRUE) +
  geom_point( aes(distance, true_incidence)) +
  labs(y = "Infection proportion CLR" ) +
  theme_classic()

binary_data_CLR%>%
  ggplot()+
  geom_smooth(aes(Shade_tree_Canopy_Cover, true_incidence), method = "glm", method.args = list(family=binomial), se = TRUE) +
  geom_point( aes(Shade_tree_Canopy_Cover, true_incidence)) +

  labs(y = "Infection proportion CLR" ) +
  theme_classic()
```

#### Coffee var

```{r}

## Compute binomial glm  
mod_binary_incidence_CLR_variety <- glmmTMB(formula = true_incidence ~ Coffee_Variety ,
                              family = binomial,
                              data = binary_data_CLR)

res_incidence_CLR_variety<- DHARMa::simulateResiduals(mod_binary_incidence_CLR_variety, plot = TRUE)
testDispersion(res_incidence_CLR_variety)
testZeroInflation(res_incidence_CLR_variety)


## Anova of type 2 and 3 are more robust that basic anova 
car::Anova(mod_binary_incidence_CLR_variety, 2)
car::Anova(mod_binary_incidence_CLR_variety, 3)

##
summ_mod_CLR <- summary(mod_binary_incidence_CLR_variety)
summ_mod_CLR

plot(allEffects(mod_binary_incidence_CLR_variety,response = "link", residuals = T,se = F))
## Basic graphic
binary_data_CLR%>%
  ggplot() +
  geom_bar(aes(Coffee_Variety, fill = as.factor(true_incidence)),position = "fill") +

  labs(y = "Infection proportion CLR" ) +
  theme_classic()
```


### 4.4 Recap incidence : graph

```{r}
data_incidence %>%
  ggplot()+
  facet_wrap(~disease) +
  geom_bar(aes(Shade_tree_species, fill = as.factor(true_incidence)), position = "fill") +
  labs(x = " Shade tree", y = "Proportion", fill = "Incidence")+
  main_theme

data_incidence %>%
  ggplot()+
  facet_wrap(~disease) +
  geom_bar(aes(Coffee_Variety, fill = as.factor(true_incidence)), position = "fill") +
  labs(x = " Coffee Variety", y = "Proportion", fill = "Incidence")+
  main_theme

data_incidence %>%
  ggplot(aes(distance, true_incidence))+
  facet_wrap(~disease) +
  geom_jitter( cex = 3, alpha =0.3, height = 0.1,width = 0) +
   geom_smooth(method = "glm", formula = y ~ x, colour = "black",
              linetype = 2, fill = "gray80", alpha = 0.2,
              method.args = list(family = binomial))+
  labs(x = " Shade tree", y = "Proportion", fill = "Incidence")+
  main_theme +
  theme_classic()
```



## 5 Severity model

### 5.1 Compute severity for each branchs

```{r}
### Isolate total cont of leaves or berries per branchs
data %>%
  select(sample_code, starts_with("No_berries"),  starts_with("No_leaves")) %>%
  pivot_longer(-sample_code, names_to = "sample_type", values_to = "total_count") %>%
  mutate(
    # Extracting "organ" ("berries" or "leaves")
    organ = str_extract(sample_type, "(?<=_)berries|leaves"),
    
    # Extracting "portion"
    portion = str_extract(sample_type, "(?<=_)lower|Top|middle"),
    
    # Extracting "branch" (e.g., "1st", "2nd", "3rd", "4th")
    branch = str_extract(sample_type, "\\d+(st|nd|rd|th)")
   ) %>%
  select(-sample_type) -> total_number_of_leaves_or_berries

### Isolate total count of leaves or berries infected per branchs
str(data)
data$No_CRBD_berries_lower_portion_3rd_branch 
data %>%
  select(sample_code, starts_with("No"),  -starts_with("No_berries"),  -starts_with("No_leaves")) %>% # extract the total number of leaves/berries and the number of leaves/berries infected
  pivot_longer(-sample_code, names_to = "sample_type", values_to = "infected_count") %>%
  mutate(
     # Extracting "disease" (e.g., "CWD", "CLR", "CRBD")
    disease = str_extract(sample_type, "(?<=_)[A-Z]+"),
    
    # Extracting "organ" ("berries" or "leaves")
    organ = str_extract(sample_type, "(?<=_)berries|leaves"),
    
    # Extracting "portion"
    portion = str_extract(sample_type, "(?<=_)lower|Top|middle"),
    
    # Extracting "branch" (e.g., "1st", "2nd", "3rd", "4th")
    branch = str_extract(sample_type, "\\d+(st|nd|rd|th)")
   ) -> number_of_infected_leaves_or_berries
number_of_infected_leaves_or_berries %>% filter(organ == "berries")
## Merge data and compute serverity per branchs
number_of_infected_leaves_or_berries %>%
  left_join(total_number_of_leaves_or_berries, by = join_by("sample_code" == "sample_code",
                                                            "branch" == "branch",
                                                            "portion" == "portion",
                                                            "organ" == "organ")) %>%
  mutate(severity = infected_count/total_count) %>%
  left_join(covariate_data, by = "sample_code") %>%
  mutate(Shade_tree_species = as.factor(Shade_tree_species)) %>%
  rename(distance = "Actual_distance_from_shade_tree_m") %>%
  mutate(distance_class = cut(
      distance,
      breaks = c(0, 8, 16, 24),  # Specify the breakpoints
      labels = c("[0-8]", "(8-16]", "(16-22]"),  # Labels for each range
      right = F), # Indicates whether intervals are right-closed
    total_count = case_when(total_count > 250 ~ round(total_count/10),
                            .default = total_count),
    log_total_count = log(total_count), # correct error (5 branch have more than 150 leaves -> error due to one digit added when tipping)
    across(where(is.character),~as.factor(.x))) -> data_severity

data_severity %>%
  filter(total_count>infected_count) -> data_severity
```
 
 Function to compute models for all disease at each 3 portions of coffee tree.
 
```{r}

severity.mod.func <- function(data, 
                              frml = formula("severity ~ Shade_tree_species*distance   + (1|sample_code/branch)"),
                              zifrml = formula("~1")){
 
  mod_severity <-  glmmTMB(formula = frml,
                              ziformula = zifrml,
                              family = binomial,
                              weights = total_count ,
                              data = data)

  res_severity <- DHARMa::simulateResiduals(mod_severity, plot = TRUE)


  par(mfrow = c(2, 3))
  testDispersion(res_severity)
  testZeroInflation(res_severity)
  plotResiduals(res_severity, form = data$distance )
  plotResiduals(res_severity, form = data$Shade_tree_species)
  plotResiduals(res_severity, form = data$log_total_count)
  plotResiduals(res_severity, form = data$Coffee_Variety)
  par(mfrow = c(1, 1))
  
  return(mod_severity)
}


plot.effect.model <- function(data, model){
  assign("data", data, envir = .GlobalEnv) 
  plot(allEffects(model))
  
  print(Anova(model))
  print(summary(model))
}

```

### 5.2 CRBD LEAVES severity model

```{r}
data_severity %>%
  filter(disease == "CRBD", organ == "leaves") -> data_severity_CRBD_leaves


data_severity_CRBD_leaves %>%
  filter(infected_count!= 0) %>%
  ggplot() +
  geom_boxplot(aes(portion, severity))


data_severity_CRBD_leaves%>%
  ggplot() +
  geom_boxplot(aes(Coffee_Variety, severity))

data_severity_CRBD_leaves%>%
  ggplot() +
  #facet_wrap(~Shade_tree_species)+
  geom_point(aes(total_count, infected_count))


data_severity_CRBD_leaves%>%
  ggplot() +
  geom_boxplot(aes(Coffee_Variety, total_count))

data_severity_CRBD_leaves%>%
  ggplot() +
  geom_smooth(aes(distance, total_count), method = "lm")+
  geom_point(aes(distance, total_count))

data_severity_CRBD_leaves%>%
  ggplot() +
  geom_boxplot(aes(Shade_tree_species, total_count))
data_severity_CRBD_leaves%>%
  ggplot() +
  facet_wrap(~Shade_tree_species)+
   geom_smooth(aes(distance, total_count), method = "lm")+
  geom_point(aes(distance, total_count))

```

#### Top portion

```{r}
# Models

data_severity_CRBD_leaves %>%
  filter(portion =="Top", !is.na(severity)) -> CRBD_leaves_top
ggplot(CRBD_leaves_top)+
  facet_wrap(~Coffee_Variety)+
  geom_point(aes(log_total_count, severity))

CRBD_leaves_top%>%
  severity.mod.func() -> mod_severity_CRBD_leaves_top
summary(mod_severity_CRBD_leaves_top)
CRBD_leaves_top%>%
  severity.mod.func(frml = formula("severity ~ Shade_tree_species*distance   + Coffee_Variety +
                                            (1|sample_code)")) -> mod_severity_CRBD_leaves_top2
CRBD_leaves_top%>%
  severity.mod.func(frml = formula("severity ~ Shade_tree_species*distance   + Coffee_Variety +
                                            (1|sample_code)"),
                              zifrml = formula("~Coffee_Variety")) -> mod_severity_CRBD_leaves_top3
CRBD_leaves_top%>%
  severity.mod.func(frml = formula("severity ~ Shade_tree_species*distance   +
                                            (1|sample_code)"),
                              zifrml = formula("~Coffee_Variety")) -> mod_severity_CRBD_leaves_top4


```



```{r}
CRBD_leaves_top %>%
  plot.effect.model(mod_severity_CRBD_leaves_top4)

Anova(mod_severity_CRBD_leaves_top4)
Anova(mod_severity_CRBD_leaves_top4, component = "zi")

anova(mod_severity_CRBD_leaves_top3, mod_severity_CRBD_leaves_top4)
library(MuMIn)
AICc(mod_severity_CRBD_leaves_top3,mod_severity_CRBD_leaves_top4)
```

### 5.3 CRBD BERRIES severity model

```{r}
data_severity %>%
  filter(disease == "CRBD", organ == "berries") -> data_severity_CRBD_berries

data_severity_CRBD_berries%>%
  ggplot() +
  geom_boxplot(aes(Coffee_Variety, severity))

data_severity_CRBD_berries%>%
  
  ggplot() +
  facet_wrap(~portion*Shade_tree_species)+
  geom_boxplot(aes(Coffee_Variety, severity))
```


#### Top
```{r}
# Models
data_severity_CRBD_berries %>%
  filter(portion =="Top") -> CRBD_berries_top

CRBD_berries_top %>%
  severity.mod.func -> mod_severity_CRBD_berries_top

CRBD_berries_top %>%
  severity.mod.func(frml = formula("severity ~ Shade_tree_species*distance   + Coffee_Variety +
                                            (1|sample_code)")) -> mod_severity_CRBD_berries_top2

CRBD_berries_top %>%
  severity.mod.func(frml = formula("severity ~ Shade_tree_species*distance   + Coffee_Variety +
                                            (1|sample_code)"),
                              zifrml = formula("~Coffee_Variety")) -> mod_severity_CRBD_berries_top3

CRBD_berries_top %>%
  severity.mod.func(frml = formula("severity ~ Shade_tree_species*distance   +
                                            (1|sample_code)"),
                              zifrml = formula("~Coffee_Variety")) -> mod_severity_CRBD_berries_top4



```


```{r}
CRBD_berries_top %>%
  plot.effect.model(mod_severity_CRBD_berries_top3)

```

```{r}
summary(mod_severity_CRBD_berries_top3)

predict_response(mod_severity_CRBD_berries_top3, c("distance [all]","Shade_tree_species"), type = "zero_inflated") %>% 
  as.data.frame %>%
  mutate(type = "fixed + zif") -> dist_shade_zif
predict_response(mod_severity_CRBD_berries_top3, c("distance [all]","Shade_tree_species"), type = "fixed") %>%
  as.data.frame %>%
  mutate(type = "fixed") %>%
  bind_rows(dist_shade_zif) %>%
  ggplot() +
  geom_ribbon(aes(x = x, y = predicted, ymin = conf.low, ymax = conf.high, fill = type), alpha= 0.5 )+
  geom_line(aes(x = x, y = predicted, col = type))+
  facet_wrap(~group) +
  scale_y_continuous(limits = c(0,1))+
  scale_color_simpsons() +
  scale_fill_simpsons() +
  main_theme


predict_response(mod_severity_CRBD_berries_top3, c("distance [all]","Shade_tree_species"), type = "fixed") %>%
  plot

predict_response(mod_severity_CRBD_berries_top3, c("Coffee_Variety"), type = "zero_inflated") %>%
  as.data.frame %>%
  mutate(type = "fixed + zif") -> coffee_var_zif
predict_response(mod_severity_CRBD_berries_top3, c("Coffee_Variety"), type = "fixed") %>%
  as.data.frame %>%
  mutate(type = "fixed") %>%
  bind_rows(coffee_var_zif) %>%
  ggplot() +
  geom_pointrange(aes(x = x, y = predicted, ymin = conf.low, ymax = conf.high, col = type), 
                  linetype =1, cex = 0.5, linewidth = 1, position = position_dodge(width = .2)) +
  scale_y_continuous(limits = c(0,1))+
  scale_color_simpsons() +
  scale_fill_simpsons() +
  main_theme +
  labs(x= "Total leaves (log count)", y = "severity") 

predict_response(mod_severity_CRBD_berries_top3, c("log_total_count [all]"), type = "zero_inflated") %>%
  as.data.frame %>%
  mutate(type = "fixed + zif") -> log_total_count_zif
predict_response(mod_severity_CRBD_berries_top3, c("log_total_count [all]"), type = "fixed") %>%
  as.data.frame %>%
  mutate(type = "fixed") %>%
  bind_rows(log_total_count_zif) %>%
  ggplot() +
  geom_ribbon(aes(x = x, y = predicted, ymin = conf.low, ymax = conf.high, fill = type), alpha= 0.5 )+
  geom_line(aes(x = x, y = predicted, col = type))+
  scale_y_continuous(limits = c(0,1))+
  scale_color_simpsons() +
  scale_fill_simpsons() +
  main_theme +
  labs(x= "Total leaves (log count)", y = "severity") 

```

### 5.4 CWD severity model

```{r}
data_severity %>%
  filter(disease == "CWD") -> data_severity_CWD


data_severity_CWD %>%
  ggplot()+
  facet_grid(rows = vars(Shade_tree_species), cols = vars(disease))+
  geom_point(aes(distance,severity)) 

data_severity_CWD %>%
  ggplot()+
  facet_grid(rows = vars(Shade_tree_species), cols = vars(portion))+
  geom_boxplot(aes(Coffee_Variety,severity)) 
```
#### All portion

```{r}

glmmTMB(formula = severity ~ Shade_tree_species*distance + portion + log_total_count + Coffee_Variety +
                                            (1|sample_code/branch),
                                            ziformula = ~Coffee_Variety,
                                            family = binomial,
                                            weights = total_count,
                                            data = data_severity_CWD) -> mod_severity_CWD

res_severity_CWD <- DHARMa::simulateResiduals(mod_severity_CWD, plot = TRUE)


testQuantiles(mod_severity_CWD)
testDispersion(res_severity_CWD)
testZeroInflation(res_severity_CWD)

model.frame(mod_severity_CWD) -> mod_frame_CWD
par(mfrow = c(2, 2))
plotResiduals(res_severity_CWD, form = mod_frame_CWD$portion)
plotResiduals(res_severity_CWD, form = mod_frame_CWD$distance, quantreg = T)
plotResiduals(res_severity_CWD, form = mod_frame_CWD$Shade_tree_species)
plotResiduals(res_severity_CWD, form = mod_frame_CWD$log_total_count, quantreg = T)
par(mfrow = c(1, 1))
plotResiduals(res_severity_CWD, form = mod_frame_CWD$Coffee_Variety)
```


```{r}
plot(allEffects(mod_severity_CWD))

Anova(mod_severity_CWD)
summary(mod_severity_CWD)
plogis(-1)
plogis(0)
plogis(-1.055421-0.902003*(log(100)))

```

### 5.5 CLR severity model

```{r}
data_severity %>%
  filter(disease == "CLR") -> data_severity_CLR


data_severity_CLR %>%
  ggplot()+
  facet_grid(rows = vars(Shade_tree_species), cols = vars(disease))+
  geom_point(aes(distance,severity)) 

data_severity_CLR %>%
  ggplot()+
  facet_grid(rows = vars(Shade_tree_species), cols = vars(portion))+
  geom_boxplot(aes(Coffee_Variety,severity)) 
```

#### Low


```{r}
# Models
data_severity_CLR %>%
  filter(portion =="lower") -> CLR_low

CLR_low %>%
  severity.mod.func-> mod_severity_CLR_low
CLR_low %>%
 severity.mod.func(frml = formula("severity ~ Shade_tree_species*distance  + log_total_count + Coffee_Variety + 
                                            (1|sample_code/branch)"),
                              zifrml = formula("~1")) -> mod_severity_CLR_low2
CLR_low %>%
 severity.mod.func(frml = formula("severity ~ Shade_tree_species*distance  + log_total_count  + Coffee_Variety+
                                            (1|sample_code/branch)"),
                              zifrml = formula("~Coffee_Variety")) -> mod_severity_CLR_low3
CLR_low %>%
 severity.mod.func(frml = formula("severity ~ Shade_tree_species*distance  + log_total_count  + 
                                            (1|sample_code/branch)"),
                              zifrml = formula("~Coffee_Variety")) -> mod_severity_CLR_low4

CLR_low %>%
 severity.mod.func(frml = formula("severity ~ Shade_tree_species*distance  + log_total_count + Coffee_Variety + 
                                            (1|sample_code/branch)"),
                              zifrml = formula("~0")) -> mod_severity_CLR_low5
```

```{r}
CLR_low %>%
  plot.effect.model(mod_severity_CLR_low4)

CLR_low %>%
  plot.effect.model(mod_severity_CLR_low5)
```

